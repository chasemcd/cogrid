# Milestone v0.2.0: Determinism Audit

**Status:** SHIPPED 2026-01-20
**Phases:** 1-4 (v0.2.0 numbering)
**Total Plans:** 4

## Overview

Ensure all CoGrid environments are fully deterministic: same seed produces identical trajectories, and restored states produce identical behavior.

## Phases

### Phase 1: Fix Step Dynamics Determinism

**Goal:** Remove randomness from step() â€” agent move priority must be deterministic.
**Depends on:** None
**Plans:** 1 plan

Plans:
- [x] 01-01: Remove agent move shuffle, replace with sort

**Details:**
- [cogrid_env.py:493](../../cogrid/cogrid_env.py#L493): Replace `np_random.shuffle(agents_to_move)` with deterministic ordering (sort by agent ID)
- Deliverable: Step dynamics produce identical results for identical inputs

---

### Phase 2: Fix Unseeded Layout Randomization

**Goal:** Ensure `Overcooked-RandomizedLayout-V0` uses the environment's seeded RNG.
**Depends on:** Phase 1
**Plans:** 1 plan

Plans:
- [x] 02-01: Thread np_random to layout functions

**Details:**
- [envs/__init__.py:128](../../cogrid/envs/__init__.py#L128): Replace `random.choice()` with seeded selection
- Update `layout_fn` signature to receive `np_random` from environment
- Thread `np_random` through layout selection
- Deliverable: RandomizedLayout variant produces identical layouts for identical seeds

---

### Phase 3: Fix sr_utils Legacy RandomState

**Goal:** Ensure Search & Rescue grid generation uses the environment's RNG.
**Depends on:** Phase 2
**Plans:** 1 plan

Plans:
- [x] 03-01: Remove legacy RandomState fallback

**Details:**
- [envs/search_rescue/sr_utils.py:20-21](../../cogrid/envs/search_rescue/sr_utils.py#L20): Remove fallback `RandomState`, require `np_random` argument
- Verify all callers pass `np_random`
- Deliverable: S&R grid generation is deterministic via environment seed

---

### Phase 4: Determinism Verification Tests

**Goal:** Add tests that verify determinism guarantees.
**Depends on:** Phases 1-3
**Plans:** 1 plan

Plans:
- [x] 04-01: Extend trajectory test to 100 steps, add restored state continuation test

**Details:**
- Test: Same seed -> identical 100-step trajectory
- Test: Restored state -> identical continuation
- Test: Agent collision resolution is deterministic
- Test: RandomizedLayout produces same layout for same seed
- Deliverable: Test suite that catches determinism regressions

---

## Success Criteria (All Met)

1. `reset(seed=X)` followed by identical actions always produces identical states
2. `set_state(state)` followed by identical actions produces identical states
3. No uses of unseeded `random` module
4. No uses of `np.random` global state
5. All randomness flows through `self.np_random` (seeded at reset)

## Milestone Summary

**Key Decisions:**
- Sort agents by ID for collision resolution (deterministic priority)
- Require explicit np_random parameter rather than fallback creation
- Backwards-compatible fallback in layout_fn for callers without np_random

**Issues Resolved:**
- Agent move shuffle broke determinism (fixed in Phase 1)
- Unseeded stdlib random in layout selection (fixed in Phase 2)
- Legacy RandomState fallback in sr_utils.py (fixed in Phase 3)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- generate_sr_grid is dead code (no callers) - fix is correct but untested in production path

---

*For current project status, see .planning/ROADMAP.md*
*Archived: 2026-01-20 as part of v0.2.0 milestone completion*
