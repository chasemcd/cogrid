---
phase: 02-overcooked-objects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/envs/overcooked/test_state_serialization.py
autonomous: true

must_haves:
  truths:
    - "Pot roundtrip preserves cooking_tick, objects_in_pot, is_ready, is_cooking"
    - "Counter with object roundtrip preserves object_on_counter with full state"
    - "Stateless objects (Onion, Tomato, Plate, Soup, Stacks, DeliveryZone) roundtrip without data loss"
    - "All Overcooked objects pass individual roundtrip tests"
  artifacts:
    - path: "cogrid/envs/overcooked/test_state_serialization.py"
      provides: "Comprehensive roundtrip tests for all Overcooked objects"
      contains: "test_pot_cooking_state_roundtrip"
  key_links:
    - from: "test_state_serialization.py"
      to: "overcooked_grid_objects.py"
      via: "imports and instantiation"
      pattern: "from cogrid.envs.overcooked import overcooked_grid_objects"
---

<objective>
Verify all Overcooked domain objects serialize correctly via comprehensive roundtrip tests.

Purpose: Research confirmed most Overcooked objects are already implemented or stateless. This plan adds verification tests to prove requirements OVER-01 through OVER-06 are satisfied by existing implementations.

Output: Extended test suite in test_state_serialization.py that verifies every Overcooked object type roundtrips correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-overcooked-objects/02-RESEARCH.md

# Key source files
@cogrid/envs/overcooked/overcooked_grid_objects.py
@cogrid/envs/overcooked/test_state_serialization.py
@cogrid/core/grid_object.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Pot cooking state verification tests</name>
  <files>cogrid/envs/overcooked/test_state_serialization.py</files>
  <action>
Add a new test method `test_pot_cooking_state_roundtrip` to TestOvercookedStateSerialization that verifies:
1. `cooking_timer` value preserved after roundtrip
2. `is_cooking` property returns same value after roundtrip (pot full with timer > 0)
3. `is_ready` (dish_ready) property returns same value after roundtrip (timer == 0)
4. `objects_in_pot` list length and ingredient types match after roundtrip

Test both states: pot mid-cooking (timer > 0) and pot ready (timer == 0).

Use the existing test pattern from `test_pot_state_serialization` as reference. Create Pot directly, set state, serialize with `get_extra_state(scope="overcooked")`, create new Pot, restore with `set_extra_state()`, verify all properties.
  </action>
  <verify>pytest cogrid/envs/overcooked/test_state_serialization.py::TestOvercookedStateSerialization::test_pot_cooking_state_roundtrip -v</verify>
  <done>Test passes, verifying OVER-01 (Pot serializes cooking_tick, objects_in_pot, is_ready, is_cooking flags)</done>
</task>

<task type="auto">
  <name>Task 2: Add stateless object roundtrip tests</name>
  <files>cogrid/envs/overcooked/test_state_serialization.py</files>
  <action>
Add a new test class `TestStatelessObjectsRoundtrip` with individual test methods for each stateless Overcooked object:

1. `test_onion_roundtrip` - Create Onion, verify `get_extra_state()` returns None, verify object can be serialized/deserialized via object_id
2. `test_tomato_roundtrip` - Same pattern for Tomato
3. `test_plate_roundtrip` - Same pattern for Plate (OVER-03: Plate is stateless, soup is separate object)
4. `test_onion_soup_roundtrip` - Same pattern for OnionSoup
5. `test_tomato_soup_roundtrip` - Same pattern for TomatoSoup
6. `test_delivery_zone_roundtrip` - Same pattern for DeliveryZone
7. `test_onion_stack_stateless` - Verify OnionStack has no count state (OVER-04: infinite source)
8. `test_tomato_stack_stateless` - Verify TomatoStack has no count state (OVER-05: infinite source)
9. `test_plate_stack_stateless` - Verify PlateStack has no count state

For each test:
- Create object instance
- Call `get_extra_state(scope="overcooked")` - should return None for stateless
- Use `make_object(object_id, scope="overcooked")` to recreate
- Verify type matches original

Document in test docstrings that stacks are infinite sources by design (no remaining count to track).
  </action>
  <verify>pytest cogrid/envs/overcooked/test_state_serialization.py::TestStatelessObjectsRoundtrip -v</verify>
  <done>All stateless object tests pass, verifying OVER-03, OVER-04, OVER-05, OVER-06</done>
</task>

<task type="auto">
  <name>Task 3: Add Counter with nested object roundtrip test</name>
  <files>cogrid/envs/overcooked/test_state_serialization.py</files>
  <action>
Add `test_counter_with_pot_soup_roundtrip` to TestOvercookedStateSerialization that verifies OVER-02 with a more complex scenario:

1. Create Counter, place OnionSoup on it (Counter holding soup)
2. Serialize via `get_extra_state(scope="overcooked")`
3. Create new Counter, restore via `set_extra_state()`
4. Verify `obj_placed_on` is OnionSoup instance
5. Verify soup's `object_id` matches

Also add `test_counter_empty_roundtrip` to verify Counter with nothing on it returns None from get_extra_state (or handles gracefully).

This extends the existing `test_counter_with_object_serialization` to cover the OVER-02 requirement for "full object state" preservation.
  </action>
  <verify>pytest cogrid/envs/overcooked/test_state_serialization.py::TestOvercookedStateSerialization::test_counter_with_pot_soup_roundtrip cogrid/envs/overcooked/test_state_serialization.py::TestOvercookedStateSerialization::test_counter_empty_roundtrip -v</verify>
  <done>Counter tests pass, verifying OVER-02 (Counter serializes object_on_counter with full object state)</done>
</task>

</tasks>

<verification>
Run full test suite for Overcooked serialization:
```bash
pytest cogrid/envs/overcooked/test_state_serialization.py -v
```

All tests should pass, including:
- Existing tests (pot_state_serialization, counter_with_object_serialization, cooking_pot_roundtrip)
- New tests (pot_cooking_state_roundtrip, all stateless object tests, counter edge cases)
</verification>

<success_criteria>
1. `pytest cogrid/envs/overcooked/test_state_serialization.py -v` passes with 0 failures
2. Test coverage includes all Overcooked object types: Pot, Counter, Onion, Tomato, Plate, OnionSoup, TomatoSoup, OnionStack, TomatoStack, PlateStack, DeliveryZone
3. Test docstrings document stateless nature of stack objects (infinite sources)
4. Requirements OVER-01 through OVER-06 are verified by test coverage
</success_criteria>

<output>
After completion, create `.planning/phases/02-overcooked-objects/02-01-SUMMARY.md`
</output>
