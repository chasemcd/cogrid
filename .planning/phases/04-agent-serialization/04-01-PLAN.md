---
phase: 04-agent-serialization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/envs/overcooked/test_state_serialization.py
autonomous: true

must_haves:
  truths:
    - "Agent holding OnionSoup roundtrips correctly"
    - "Agent holding TomatoSoup roundtrips correctly"
    - "OvercookedAgent type is preserved after roundtrip"
    - "OvercookedAgent can_pickup behavior works correctly after roundtrip"
    - "Empty inventory roundtrips correctly"
  artifacts:
    - path: "cogrid/envs/overcooked/test_state_serialization.py"
      provides: "Agent serialization verification tests"
      contains: "test_agent_holding_onion_soup"
  key_links:
    - from: "Agent.get_state()"
      to: "obj.get_extra_state()"
      via: "inventory serialization loop"
      pattern: "obj\\.get_extra_state"
    - from: "Agent.from_state()"
      to: "obj.set_extra_state()"
      via: "inventory restoration loop"
      pattern: "obj\\.set_extra_state"
---

<objective>
Verify agent serialization works correctly for all inventory object types and domain-specific agent classes.

Purpose: Research confirmed that agent serialization is already fully implemented in `Agent.get_state()` / `from_state()`. This plan adds comprehensive roundtrip tests to verify the existing implementation handles all edge cases.

Output: Extended test coverage in the existing test file confirming AGNT-01 and AGNT-02 requirements are met.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-serialization/04-RESEARCH.md

# Existing test file to extend
@cogrid/envs/overcooked/test_state_serialization.py

# Agent serialization implementation (already complete)
@cogrid/core/agent.py
@cogrid/envs/overcooked/agent.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agent inventory roundtrip tests for various object types</name>
  <files>cogrid/envs/overcooked/test_state_serialization.py</files>
  <action>
Add a new test class `TestAgentSerializationRoundtrip` to the existing test file with these tests:

1. `test_agent_holding_onion_soup_roundtrip()`:
   - Create agent with OnionSoup in inventory
   - Verify get_state captures inventory with correct object_id
   - Restore via from_state
   - Verify restored inventory contains OnionSoup instance with matching object_id

2. `test_agent_holding_tomato_soup_roundtrip()`:
   - Same pattern as above but with TomatoSoup
   - Different object_id verification

3. `test_agent_holding_simple_objects_roundtrip()`:
   - Test with Onion, Tomato, Plate (stateless objects)
   - Verify all roundtrip via object_id

4. `test_agent_empty_inventory_roundtrip()`:
   - Agent with empty inventory []
   - Verify empty list preserved after roundtrip

5. `test_agent_full_inventory_roundtrip()`:
   - Agent with inventory_capacity > 1 holding multiple items
   - Verify all items restored in correct order

Use the existing test pattern from `test_agent_inventory_serialization` as reference. Import Agent from cogrid.core.agent and use Agent.from_state() for restoration tests.
  </action>
  <verify>pytest cogrid/envs/overcooked/test_state_serialization.py -v -k "TestAgentSerializationRoundtrip" passes all new tests</verify>
  <done>5 new agent inventory roundtrip tests pass, covering OnionSoup, TomatoSoup, simple objects, empty inventory, and multi-item inventory</done>
</task>

<task type="auto">
  <name>Task 2: Add OvercookedAgent type and behavior preservation tests</name>
  <files>cogrid/envs/overcooked/test_state_serialization.py</files>
  <action>
Add tests to the `TestAgentSerializationRoundtrip` class:

1. `test_overcooked_agent_type_preserved()`:
   - Create OvercookedAgent instance
   - Serialize via get_state()
   - Restore via OvercookedAgent.from_state()
   - Verify restored agent is OvercookedAgent instance (not base Agent)
   - Use `self.assertIsInstance(restored, OvercookedAgent)`

2. `test_overcooked_agent_can_pickup_behavior()`:
   - Create OvercookedAgent, serialize, restore
   - Verify can_pickup() method works correctly after roundtrip
   - Test that the behavior difference from base Agent is preserved
   - Import OvercookedAgent from cogrid.envs.overcooked.agent

3. `test_full_env_agent_type_preserved()`:
   - Use the OvercookedStateTest environment
   - Verify env.env_agents contains OvercookedAgent instances after set_state
   - This verifies the environment correctly uses agent_class for restoration

Import OvercookedAgent from cogrid.envs.overcooked.agent at the top of the file.
  </action>
  <verify>pytest cogrid/envs/overcooked/test_state_serialization.py -v -k "overcooked_agent" passes all new tests</verify>
  <done>3 new OvercookedAgent tests pass, confirming type preservation and behavior preservation after roundtrip (AGNT-02)</done>
</task>

<task type="auto">
  <name>Task 3: Verify all tests pass and document requirements coverage</name>
  <files>cogrid/envs/overcooked/test_state_serialization.py</files>
  <action>
1. Run full test suite for the file:
   - pytest cogrid/envs/overcooked/test_state_serialization.py -v
   - All existing tests must still pass
   - All new tests must pass

2. Add docstrings to the new test class documenting requirements coverage:
   - Class docstring: "Test agent serialization roundtrips for AGNT-01 and AGNT-02"
   - Each test method docstring should reference which requirement it verifies

3. Verify via audit script that GridAgent concern is resolved:
   - Run: python scripts/audit_serialization.py
   - Note: GridAgent is intentionally NOT serialized (ephemeral, regenerated from Agent state)
   - This is correct behavior per the research findings

4. Commit with message format:
   test(04-01): verify agent serialization roundtrip (AGNT-01/AGNT-02)

   - Agent inventory roundtrips for all object types (soups, simple objects)
   - OvercookedAgent type preserved after roundtrip
   - OvercookedAgent can_pickup behavior works after roundtrip
   - No implementation changes needed - serialization already complete

   Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
  </action>
  <verify>
- pytest cogrid/envs/overcooked/test_state_serialization.py -v shows all tests pass (should be ~30+ tests)
- Git commit created with proper message
  </verify>
  <done>All tests pass, requirements AGNT-01 and AGNT-02 verified complete, changes committed</done>
</task>

</tasks>

<verification>
Phase-level checks:
- [ ] All existing tests in test_state_serialization.py still pass
- [ ] New TestAgentSerializationRoundtrip class exists with 8 new tests
- [ ] Agent holding various object types (OnionSoup, TomatoSoup, Onion, Tomato, Plate) roundtrip correctly
- [ ] OvercookedAgent type is preserved after roundtrip (not base Agent)
- [ ] OvercookedAgent behavior (can_pickup) works correctly after roundtrip
- [ ] Requirements AGNT-01 and AGNT-02 verified complete
</verification>

<success_criteria>
1. pytest cogrid/envs/overcooked/test_state_serialization.py -v passes with all tests (existing + 8 new)
2. New test class TestAgentSerializationRoundtrip contains tests for:
   - Agent holding OnionSoup
   - Agent holding TomatoSoup
   - Agent holding simple objects
   - Agent with empty inventory
   - Agent with multiple items
   - OvercookedAgent type preservation
   - OvercookedAgent can_pickup behavior
   - Full environment agent type preservation
3. Git commit created documenting the verification work
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-serialization/04-01-SUMMARY.md`
</output>
