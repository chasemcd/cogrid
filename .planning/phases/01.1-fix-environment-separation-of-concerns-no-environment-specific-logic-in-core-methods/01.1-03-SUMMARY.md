---
phase: 01.1-fix-environment-separation-of-concerns
plan: 03
subsystem: core-infrastructure
tags: [scope-config, separation-of-concerns, generic-dispatch, interactions, grid-utils, array-rewards]

# Dependency graph
requires:
  - phase: 01.1-01
    provides: "Scope config registry and Overcooked array config module"
  - phase: 01.1-02
    provides: "Overcooked rewards and interaction tests moved to envs/overcooked/"
provides:
  - "Zero environment-specific logic in cogrid/cogrid_env.py, cogrid/core/interactions.py, cogrid/core/grid_utils.py, cogrid/core/array_rewards.py"
  - "Generic process_interactions_array() with scope config handler delegation"
  - "Generic layout_to_array_state() with scope config state_extractor delegation"
  - "Phase 01.1 goal achieved: complete separation of concerns"
affects: [phase-02-functional-state-model]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Handler delegation with fallthrough: interaction_handler returns bool, False triggers generic fallback"
    - "State extractor callback: scope config provides grid-to-array extraction logic"
    - "extra_state kwargs: scope-specific arrays passed through generic functions via **kwargs"

key-files:
  created: []
  modified:
    - cogrid/cogrid_env.py
    - cogrid/core/interactions.py
    - cogrid/core/grid_utils.py
    - cogrid/core/array_rewards.py
    - cogrid/envs/overcooked/test_interactions.py

key-decisions:
  - "Handler delegation with fallthrough for branch 2/4: interaction_handler returns True/False, False allows generic fallback (e.g. counter place_on)"
  - "tick_objects_array() removed from core entirely -- Overcooked tick handler called directly from scope config"
  - "Docstring references to Overcooked (e.g. examples) kept as informational -- only code logic references removed"
  - "extra_state passed as **kwargs to process_interactions_array for scope-specific arrays (pot_contents, pot_timer, etc.)"

patterns-established:
  - "Core modules are purely generic: they accept scope_config and delegate all env-specific logic"
  - "Handler delegation with fallthrough: handlers return bool to indicate if they handled the interaction, allowing generic fallback"
  - "State extraction delegation: layout_to_array_state calls scope_config state_extractor for container state"

# Metrics
duration: 8min
completed: 2026-02-12
---

# Phase 01.1 Plan 03: Wire Scope Config and Remove Overcooked Logic from Core Summary

**Generic scope-config-driven dispatch in cogrid_env.py, interactions.py, grid_utils.py replacing all hardcoded Overcooked logic with handler delegation pattern**

## Performance

- **Duration:** 8 min
- **Started:** 2026-02-11T20:04:15Z
- **Completed:** 2026-02-12T03:09:05Z
- **Tasks:** 2
- **Files modified:** 5

## Accomplishments
- Replaced _build_type_ids() and if-scope-overcooked conditional in cogrid_env.py with get_scope_config() call
- Refactored process_interactions_array() from 420-line Overcooked-specific implementation to 160-line generic skeleton with handler delegation
- Removed pot detection from layout_to_array_state(), delegating to scope config state_extractor
- Removed backward-compatible re-exports from core/array_rewards.py (only compose_rewards remains)
- Removed build_interaction_tables(), _place_on_pot(), _place_on_non_pot(), tick_objects_array() from core/interactions.py
- Updated all 10 call sites in test_interactions.py to new signature with scope_config and **extra_state
- All 8 parity tests pass, 200-step Overcooked smoke test passes, non-Overcooked scopes work

## Task Commits

Each task was committed atomically:

1. **Task 1: Wire scope config into cogrid_env.py** - `8d36d8d` (refactor)
2. **Task 2: Refactor core modules to generic skeleton, clean grid_utils.py and array_rewards.py** - `ef96734` (refactor)

## Files Created/Modified
- `cogrid/cogrid_env.py` - Uses get_scope_config() for type_ids, interaction_tables, and state extraction; _build_type_ids() deleted
- `cogrid/core/interactions.py` - Generic process_interactions_array() with scope_config handler delegation; all Overcooked-specific functions removed
- `cogrid/core/grid_utils.py` - Generic layout_to_array_state() with state_extractor delegation; pot detection removed
- `cogrid/core/array_rewards.py` - Only compose_rewards() remains; backward-compat re-exports removed
- `cogrid/envs/overcooked/test_interactions.py` - Updated to new API: scope_config, **extra_state pattern, imports from array_config

## Decisions Made
- Handler delegation with fallthrough: interaction_handler returns True/False. When False, generic fallback runs (e.g. counter place_on uses generic object_state_map storage). This preserves the original priority chain semantics where dynamic condition failures fall through to later branches.
- tick_objects_array() removed from core entirely rather than wrapped as thin dispatcher. The Overcooked tick handler is accessed directly via scope_config["tick_handler"].
- Docstring references to "e.g. Overcooked" and "e.g. pot_contents" kept as informational examples in generic modules. Only code logic (type checks, string comparisons, function calls) was removed.
- extra_state passed as **kwargs to process_interactions_array, allowing scope-specific arrays to flow through without the generic skeleton knowing their structure. The interaction_handler receives them as a dict for mutation.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed handler delegation fallthrough for priority branches**
- **Found during:** Task 2 (refactoring interactions.py)
- **Issue:** Plan's elif chain would prevent fallthrough from branch 2 to branches 3-4 when handler returns False (e.g. pot not ready with CAN_PICKUP_FROM=1). Original code had dynamic condition in elif that allowed fallthrough.
- **Fix:** Changed from elif chain to sequential if-not-handled chain, preserving original semantics where failed dynamic conditions fall through to later branches.
- **Files modified:** cogrid/core/interactions.py
- **Verification:** All 8 parity tests pass including pot workflow (place ingredient into pot uses branch 4 fallthrough)
- **Committed in:** ef96734 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 bug fix)
**Impact on plan:** Essential for parity correctness. The elif approach from the plan would have broken pot ingredient placement. No scope creep.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 01.1 goal ACHIEVED: zero environment-specific logic in core methods
- All core modules (cogrid_env.py, interactions.py, grid_utils.py, array_rewards.py) are purely generic
- All Overcooked-specific array logic lives in cogrid/envs/overcooked/ (array_config.py, array_rewards.py, test_interactions.py)
- Scope config registry pattern established for future environment scopes
- Ready for Phase 2: functional state model and JIT compatibility

## Self-Check: PASSED

- FOUND: cogrid/cogrid_env.py
- FOUND: cogrid/core/interactions.py
- FOUND: cogrid/core/grid_utils.py
- FOUND: cogrid/core/array_rewards.py
- FOUND: cogrid/envs/overcooked/test_interactions.py
- FOUND: commit 8d36d8d
- FOUND: commit ef96734
- FOUND: SUMMARY.md

---
*Phase: 01.1-fix-environment-separation-of-concerns*
*Completed: 2026-02-12*
