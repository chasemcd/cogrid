---
phase: 18.1-remove-environment-specific-logic-from-core-files
plan: 01
subsystem: core
tags: [autowire, component-registry, feature-order, layout-index, refactoring]

# Dependency graph
requires:
  - phase: 18
    provides: "Autowired ArrayFeature composition in CoGridEnv.reset()"
provides:
  - "register_feature_order/get_feature_order/get_pre_compose_hook API in component_registry.py"
  - "register_layout_indices/get_layout_index API in component_registry.py"
  - "Zero environment-specific logic in cogrid_env.py and cogrid/core/"
affects: [phase-19]

# Tech tracking
tech-stack:
  added: []
  patterns: ["Domain modules register feature ordering and layout mappings at import time via component_registry"]

key-files:
  created: []
  modified:
    - cogrid/core/component_registry.py
    - cogrid/core/autowire.py
    - cogrid/envs/overcooked/overcooked_array_features.py
    - cogrid/cogrid_env.py
    - cogrid/tests/test_overcooked_array_features.py
    - cogrid/core/interactions.py
    - cogrid/core/movement.py
    - cogrid/core/grid_utils.py
    - cogrid/core/step_pipeline.py

key-decisions:
  - "Feature order and pre-compose hooks registered in component_registry, looked up generically by autowire"
  - "Layout index mapping registered in component_registry, looked up generically by cogrid_env.py"
  - "Overcooked domain module registers all domain-specific data at module level (import-time)"

patterns-established:
  - "register_feature_order: domain modules declare explicit feature ordering via component_registry at import time"
  - "register_layout_indices: domain modules declare layout-to-index mappings via component_registry at import time"
  - "pre_compose_hook: domain modules register hooks for pre-composition state setup (e.g. LayoutID._layout_idx)"

# Metrics
duration: 7min
completed: 2026-02-14
---

# Phase 18.1 Plan 01: Remove Environment-Specific Logic from Core Files Summary

**Feature order registry and layout index registry in component_registry.py, removing all Overcooked-specific logic from autowire.py and cogrid_env.py**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-14T15:50:37Z
- **Completed:** 2026-02-14T15:57:37Z
- **Tasks:** 3
- **Files modified:** 9

## Accomplishments
- Removed hardcoded `_FEATURE_ORDER` dict and conditional `LayoutID` import from `autowire.py`
- Removed hardcoded `_overcooked_layouts` list from `cogrid_env.py`
- Added `register_feature_order`, `get_feature_order`, `get_pre_compose_hook`, `register_layout_indices`, `get_layout_index` to `component_registry.py`
- Moved all Overcooked-specific feature ordering, layout mapping, and pre-compose hook to `overcooked_array_features.py`
- Cleaned all environment-specific references from core docstrings/comments
- All 23 overcooked tests pass with identical 677-dim observations

## Task Commits

Each task was committed atomically:

1. **Task 1: Add feature order registration API and move Overcooked feature order to domain module** - `91f14a3` (feat)
2. **Task 2: Remove Overcooked layout list from cogrid_env.py and make layout_idx resolution generic** - `f8575e4` (feat)
3. **Task 3: Clean up environment-specific references in core docstrings/comments** - `f43b074` (docs)

## Files Created/Modified
- `cogrid/core/component_registry.py` - Added feature order, pre-compose hook, and layout index registries with registration and query functions
- `cogrid/core/autowire.py` - Removed `_FEATURE_ORDER` dict, conditional import, and scope-gated branching; now uses generic registry lookups
- `cogrid/envs/overcooked/overcooked_array_features.py` - Added `register_feature_order` and `register_layout_indices` calls at module level
- `cogrid/cogrid_env.py` - Replaced hardcoded layout list with `get_layout_index()` call
- `cogrid/tests/test_overcooked_array_features.py` - Replaced hardcoded layout list with `get_layout_index()` call
- `cogrid/core/interactions.py` - Generic docstring language
- `cogrid/core/movement.py` - Generic docstring language
- `cogrid/core/grid_utils.py` - Generic docstring language
- `cogrid/core/step_pipeline.py` - Generic docstring language

## Decisions Made
- Feature order and pre-compose hooks use the same component_registry pattern as existing registries (consistency)
- Layout index mapping returns 0 for unknown scopes/layouts (safe default, matches previous behavior)
- Pre-compose hook signature is `(layout_idx: int, scope: str) -> None` for forward compatibility

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
- Pre-existing test ordering issue: JAX backend test (`test_cross_backend_parity.py`) sets global backend to 'jax', causing subsequent numpy tests to fail when run in the same process. This is a known issue documented in STATE.md and not related to this plan's changes. All tests pass when run in isolation.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All environment-specific logic is now in domain modules
- Core files (`cogrid/core/`) and `cogrid_env.py` contain zero environment-specific references
- Ready for Phase 19 (remove legacy code paths)

## Self-Check: PASSED

All 9 modified files verified present. All 3 task commits (91f14a3, f8575e4, f43b074) verified in git log.

---
*Phase: 18.1-remove-environment-specific-logic-from-core-files*
*Completed: 2026-02-14*
