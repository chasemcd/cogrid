# Plan 01-01: Remove Agent Move Shuffle

## Frontmatter

```yaml
wave: 1
depends_on: []
files_modified:
  - cogrid/cogrid_env.py
autonomous: true
```

## Objective

Remove non-deterministic agent move priority shuffling from `step()`. Replace with deterministic ordering by agent ID.

## Context

**Problem:** [cogrid_env.py:493](../../cogrid/cogrid_env.py#L493) shuffles `agents_to_move` using `np_random.shuffle()`. This means identical actions can produce different collision outcomes across runs, breaking replay fidelity.

**Fix:** Sort by agent ID instead of shuffling. This makes collision resolution deterministic.

## Tasks

<task id="1">
Edit cogrid/cogrid_env.py line 493.

Replace:
```python
self.np_random.shuffle(agents_to_move)
```

With:
```python
agents_to_move.sort()
```

This ensures agent 0 always has priority over agent 1, etc.
</task>

<task id="2">
Run existing tests to verify no regressions:

```bash
pytest cogrid/envs/overcooked/test_state_serialization.py -v
```
</task>

<task id="3">
Create a determinism test that verifies identical actions produce identical results:

Add to cogrid/tests/test_determinism.py:

```python
"""Tests for step dynamics determinism."""
import unittest
from cogrid.envs import registry
from cogrid.core.actions import Actions


class TestStepDeterminism(unittest.TestCase):
    """Verify step() is deterministic for identical inputs."""

    def test_identical_actions_produce_identical_states(self):
        """Same seed + same actions = same state, every time."""
        env1 = registry.make("Overcooked-CrampedRoom-V0")
        env2 = registry.make("Overcooked-CrampedRoom-V0")

        env1.reset(seed=42)
        env2.reset(seed=42)

        # Run 50 steps with identical actions
        for _ in range(50):
            actions = {0: Actions.MoveRight, 1: Actions.MoveLeft}
            obs1, _, _, _, _ = env1.step(actions)
            obs2, _, _, _, _ = env2.step(actions)

            # States must be identical
            state1 = env1.get_state()
            state2 = env2.get_state()

            # Compare agent positions
            for agent_id in state1["agents"]:
                self.assertEqual(
                    state1["agents"][agent_id]["pos"],
                    state2["agents"][agent_id]["pos"],
                    f"Agent {agent_id} position diverged at step {env1.t}"
                )

        env1.close()
        env2.close()

    def test_collision_resolution_deterministic(self):
        """When agents collide, resolution is deterministic."""
        results = []

        for _ in range(10):
            env = registry.make("Overcooked-CrampedRoom-V0")
            env.reset(seed=42)

            # Force agents toward each other
            for _ in range(20):
                actions = {0: Actions.MoveRight, 1: Actions.MoveLeft}
                env.step(actions)

            # Record final positions
            state = env.get_state()
            positions = tuple(
                tuple(state["agents"][a]["pos"]) for a in sorted(state["agents"])
            )
            results.append(positions)
            env.close()

        # All runs should produce identical results
        self.assertEqual(len(set(results)), 1, "Collision resolution is non-deterministic")


if __name__ == "__main__":
    unittest.main()
```
</task>

<task id="4">
Run the new determinism test:

```bash
pytest cogrid/tests/test_determinism.py -v
```
</task>

## Verification

```bash
# All tests pass
pytest cogrid/envs/overcooked/test_state_serialization.py cogrid/tests/test_determinism.py -v
```

## must_haves

- [ ] `np_random.shuffle(agents_to_move)` removed from cogrid_env.py
- [ ] Replaced with deterministic `agents_to_move.sort()`
- [ ] New determinism test passes
- [ ] Existing serialization tests still pass
