---
phase: 23-naming-consistency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/core/array_features.py
  - cogrid/feature_space/array_features.py
  - cogrid/envs/overcooked/overcooked_array_features.py
  - cogrid/core/step_pipeline.py
  - cogrid/core/autowire.py
  - cogrid/cogrid_env.py
  - cogrid/tests/test_array_features.py
  - cogrid/tests/test_autowire.py
autonomous: true

must_haves:
  truths:
    - "grep -r 'state_dict' --include='*.py' cogrid/ returns zero hits -- the parameter name is fully eliminated"
    - "All feature function signatures use 'state' as the parameter name for environment state"
    - "All 125+ tests plus 5 overcooked env tests pass without modification to assertions"
  artifacts:
    - path: "cogrid/core/array_features.py"
      provides: "ArrayFeature base class and compose_features using state parameter"
      contains: "def composed_fn(state, agent_idx)"
    - path: "cogrid/feature_space/array_features.py"
      provides: "Legacy feature builders using state parameter"
      contains: "def fn(state, agent_idx)"
    - path: "cogrid/envs/overcooked/overcooked_array_features.py"
      provides: "Overcooked feature subclasses using state parameter"
      contains: "def fn(state, agent_idx)"
  key_links:
    - from: "cogrid/core/step_pipeline.py"
      to: "cogrid/core/array_features.py"
      via: "state_dict variable renamed to state in step/reset functions"
      pattern: "state = envstate_to_dict"
    - from: "cogrid/tests/test_array_features.py"
      to: "cogrid/core/array_features.py"
      via: "test closures use state parameter matching production code"
      pattern: "def fn\\(state, agent_idx\\)"
---

<objective>
Rename `state_dict` parameter to `state` across all feature, reward, and termination function signatures and their call sites.

Purpose: The `state_dict` name is a legacy holdover from before StateView was introduced. The value is actually a StateView (attribute-accessible), not a plain dict. Using `state` is shorter, accurate, and consistent with how reward functions already name this parameter.

Output: Zero occurrences of `state_dict` in any .py file under cogrid/.
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@cogrid/core/array_features.py
@cogrid/feature_space/array_features.py
@cogrid/envs/overcooked/overcooked_array_features.py
@cogrid/core/step_pipeline.py
@cogrid/core/autowire.py
@cogrid/cogrid_env.py
@cogrid/tests/test_array_features.py
@cogrid/tests/test_autowire.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename state_dict to state in production code</name>
  <files>
    cogrid/core/array_features.py
    cogrid/feature_space/array_features.py
    cogrid/envs/overcooked/overcooked_array_features.py
    cogrid/core/step_pipeline.py
    cogrid/core/autowire.py
    cogrid/cogrid_env.py
  </files>
  <action>
Perform a mechanical rename of `state_dict` to `state` in all production files. This is a pure text replacement -- no behavioral changes.

**cogrid/core/array_features.py** (~15 occurrences):
- Docstrings: `state_dict` -> `state` in all docstring text (parameter descriptions, usage examples)
- `compose_features` inner function: `def composed_fn(state_dict, agent_idx)` -> `def composed_fn(state, agent_idx)`
- All references inside `composed_fn`: `fn(state_dict, agent_idx)`, `fn(state_dict, i)`, `fn(state_dict)` -> use `state`
- Example code in docstrings: update the `def fn(state_dict, agent_idx):` example

**cogrid/feature_space/array_features.py** (~15 occurrences):
- `get_all_agent_obs` signature and docstring: `state_dict` -> `state`
- Inner closures in `AgentDirFeature.build_feature_fn`, `AgentPosFeature.build_feature_fn`, `CanMoveDirFeature.build_feature_fn`, `InventoryFeature.build_feature_fn`: `def fn(state_dict, agent_idx)` -> `def fn(state, agent_idx)` and all `state_dict.xxx` -> `state.xxx`

**cogrid/envs/overcooked/overcooked_array_features.py** (~30 occurrences):
- All `build_feature_fn` inner closures: `def fn(state_dict, agent_idx)` or `def fn(state_dict)` -> use `state`
- All `state_dict.xxx` attribute accesses inside those closures -> `state.xxx`

**cogrid/core/step_pipeline.py** (~8 occurrences):
- Local variable assignments: `state_dict = envstate_to_dict(state)` -> rename the local variable to something that doesn't conflict with the existing `state` parameter. Use `sv` (StateView) since `state` is already taken by the EnvState parameter. Pattern: `sv = envstate_to_dict(state)` then `obs = get_all_agent_obs(feature_fn, sv, ...)` and `rewards = compute_fn(prev_sv, sv, ...)` etc.
- IMPORTANT: In `_step_inner` the EnvState parameter is already called `state`. The `state_dict` local var is a *derived* StateView. Rename the local var to `sv` (not `state`) to avoid shadowing. Same in `_reset_obs`.
- Also rename `prev_dict` to `prev_sv` for consistency.
- Update the docstring reference to `state_dict` in the terminated_fn signature description.

**cogrid/core/autowire.py** (~2 occurrences):
- Docstring text only: `fn(state_dict, agent_idx)` -> `fn(state, agent_idx)`

**cogrid/cogrid_env.py** (~1 occurrence):
- Docstring in `add_termination_fn`: `(prev_state_dict, state_dict, reward_config)` -> `(prev_state, state, reward_config)`
  </action>
  <verify>
Run: `grep -r 'state_dict' --include='*.py' cogrid/` -- should return zero hits.
Run: `python -m pytest cogrid/tests/ -x -q` -- all tests pass.
  </verify>
  <done>Zero occurrences of `state_dict` in any .py file. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Rename state_dict to state in test code</name>
  <files>
    cogrid/tests/test_array_features.py
    cogrid/tests/test_autowire.py
  </files>
  <action>
Perform the same mechanical rename of `state_dict` to `state` in all test files.

**cogrid/tests/test_array_features.py** (~60 occurrences):
- All inner closures: `def fn(state_dict, agent_idx)` -> `def fn(state, agent_idx)`, `def fn(state_dict)` -> `def fn(state)`
- All local variables named `state_dict`: `state_dict = _sv(...)` -> `state = _sv(...)`
- All call sites: `fn(state_dict, idx)` -> `fn(state, idx)`, `fn(state_dict)` -> `fn(state)`
- All attribute accesses in assertions: `state_dict.agent_dir` -> `state.agent_dir`, etc.

**cogrid/tests/test_autowire.py** (~3 occurrences):
- Comment: `# Build a state_dict from a real Overcooked environment` -> `# Build a state from a real Overcooked environment`
- Local variable: `state_dict = envstate_to_dict(...)` -> `state_view = envstate_to_dict(...)` (use `state_view` here since `state` may conflict with env state in test context)
- Call site: `feature_fn(state_dict, agent_idx=0)` -> `feature_fn(state_view, agent_idx=0)`

Run full test suite after changes to confirm parity.
  </action>
  <verify>
Run: `grep -r 'state_dict' --include='*.py' cogrid/tests/` -- should return zero hits.
Run: `python -m pytest cogrid/tests/ -x -q` -- all tests pass.
Run: `python -m pytest cogrid/test_overcooked_env.py -x -q` -- overcooked tests pass.
  </verify>
  <done>Zero occurrences of `state_dict` in test files. Full test suite passes including overcooked env tests.</done>
</task>

</tasks>

<verification>
1. `grep -r 'state_dict' --include='*.py' cogrid/` returns zero hits
2. `python -m pytest cogrid/tests/ -x -q` passes all tests
3. `python -m pytest cogrid/test_overcooked_env.py -x -q` passes overcooked tests
</verification>

<success_criteria>
- The string `state_dict` does not appear anywhere in the codebase (.py files)
- All feature functions use `state` as their parameter name
- All existing tests pass without modification to assertions (only parameter/variable names changed)
</success_criteria>

<output>
After completion, create `.planning/phases/23-naming-consistency/23-01-SUMMARY.md`
</output>
