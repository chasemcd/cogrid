---
phase: 23-naming-consistency
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/envs/overcooked/array_config.py
  - cogrid/core/step_pipeline.py
  - cogrid/core/grid.py
  - cogrid/core/grid_object_base.py
  - cogrid/tests/test_reward_parity.py
autonomous: true

must_haves:
  truths:
    - "No function signature in cogrid/ contains single-letter parameter names except x/y in rendering geometry functions and standard loop variables i/j/k"
    - "The parameter `i` in overcooked interaction handler signatures is renamed to `agent_idx`"
    - "The parameter `n` in _backend_rng is renamed to `n_agents`"
    - "The parameter `v` in Grid.set is renamed to `obj`"
    - "The parameter `d` in _dict_to_sv is renamed to `fields`"
    - "The parameter `num_agents` in AgentObj.__init__ is renamed to `n_agents` for consistency with internal naming"
    - "All 125+ tests plus 5 overcooked env tests pass without modification to assertions"
  artifacts:
    - path: "cogrid/envs/overcooked/array_config.py"
      provides: "Overcooked interaction handlers with agent_idx parameter"
      contains: "def _interact_pickup.*agent_idx"
    - path: "cogrid/core/step_pipeline.py"
      provides: "_backend_rng with n_agents parameter"
      contains: "def _backend_rng(rng_key, mode, n_agents)"
    - path: "cogrid/core/grid.py"
      provides: "Grid.set with obj parameter"
      contains: "def set(self, row: int, col: int, obj"
  key_links:
    - from: "cogrid/envs/overcooked/array_config.py"
      to: "cogrid/core/interactions.py"
      via: "interaction handler signature matches protocol"
      pattern: "agent_idx.*agent_inv.*otm.*osm"
---

<objective>
Eliminate single-letter parameter names from function signatures and standardize terminology for `num_agents` vs `n_agents`.

Purpose: Single-letter parameters like `i`, `n`, `v`, `d` in function signatures hurt readability -- a developer must trace context to understand what they mean. Renaming to descriptive names (`agent_idx`, `n_agents`, `obj`, `fields`) makes every signature self-documenting.

Output: No single-letter parameters in function signatures outside rendering geometry (`x`, `y`, `r`, `cx`, `cy`, `a`, `b`, `c` in point-in-shape functions) and standard loop variables.
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@cogrid/envs/overcooked/array_config.py
@cogrid/core/step_pipeline.py
@cogrid/core/grid.py
@cogrid/core/grid_object_base.py
@cogrid/tests/test_reward_parity.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename single-letter parameters in overcooked interaction handlers</name>
  <files>
    cogrid/envs/overcooked/array_config.py
  </files>
  <action>
Rename the `i` parameter to `agent_idx` in all overcooked interaction handler function signatures and their bodies. This parameter represents the agent index in every case.

**Functions to update (signature + body references):**

1. `wrapped(i, ...)` in `_wrap_for_extra_state` (line ~85) -> `wrapped(agent_idx, ...)`
   - Update the call to `original_fn(i, ...)` -> `original_fn(agent_idx, ...)`

2. `_interact_pickup(base_ok, fwd_type, fwd_r, fwd_c, inv_item, i, ...)` -> replace `i` with `agent_idx`
   - Body: `set_at(agent_inv, (i, 0), fwd_type)` -> `set_at(agent_inv, (agent_idx, 0), fwd_type)`

3. `_interact_pickup_from_pot(..., inv_item, i, ...)` -> replace `i` with `agent_idx`
   - Body: `set_at(agent_inv, (i, 0), soup_type)` -> `(agent_idx, 0)`

4. `_interact_pickup_from_stack(..., inv_item, i, ...)` -> replace `i` with `agent_idx`
   - Body: `set_at(agent_inv, (i, 0), produced)` -> `(agent_idx, 0)`

5. `_interact_drop_on_empty(..., inv_item, i, ...)` (around line 371) -> replace `i` with `agent_idx`
   - Body: `set_at(agent_inv, (i, 0), -1)` -> `(agent_idx, 0)`

6. `_interact_place_on_pot(b4_base, fwd_type, inv_item, i, ...)` -> replace `i` with `agent_idx`
   - Body: `set_at(agent_inv, (i, 0), -1)` -> `(agent_idx, 0)`

7. `_interact_place_on_delivery(b4_base, fwd_type, inv_item, i, ...)` -> replace `i` with `agent_idx`
   - Body: `set_at(agent_inv, (i, 0), -1)` -> `(agent_idx, 0)`

8. `_interact_place_on_counter(b4_base, fwd_type, fwd_r, fwd_c, inv_item, i, ...)` -> replace `i` with `agent_idx`
   - Body: `set_at(agent_inv, (i, 0), -1)` -> `(agent_idx, 0)`

Also check the main `overcooked_interaction_body` function and its inner loop if it passes `i` as argument -- update the call sites to pass the same variable (the loop variable `i` used in `for i in range(n_agents)` is a standard loop variable and stays as `i`; it's the *parameter* receiving it that should be `agent_idx`).

NOTE: The rendering functions in `cogrid/visualization/rendering.py` use `x`, `y`, `r`, `a`, `b`, `c` as parameters in geometric helper functions (`point_in_circle`, `point_in_line`, `point_in_rect`, `point_in_triangle`, `rotate_fn`). These are standard mathematical/geometry conventions and should NOT be renamed. The `h`, `s`, `v` parameters in `_hsv_to_rgb` are also standard color-space conventions and should NOT be renamed.
  </action>
  <verify>
Run: `python -m pytest cogrid/tests/ -x -q` -- all tests pass.
Run: `python -m pytest cogrid/test_overcooked_env.py -x -q` -- overcooked tests pass.
Run: `python -m pytest cogrid/envs/overcooked/test_interactions.py -x -q` -- interaction tests pass.
  </verify>
  <done>All overcooked interaction handlers use `agent_idx` instead of `i`. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Rename remaining single-letter params and standardize num_agents</name>
  <files>
    cogrid/core/step_pipeline.py
    cogrid/core/grid.py
    cogrid/core/grid_object_base.py
    cogrid/tests/test_reward_parity.py
    cogrid/cogrid_env.py
  </files>
  <action>
Fix remaining single-letter parameters and the `num_agents` terminology inconsistency.

**Single-letter parameter renames:**

1. **cogrid/core/step_pipeline.py** line ~49:
   `def _backend_rng(rng_key, mode, n)` -> `def _backend_rng(rng_key, mode, n_agents)`
   - Update all references to `n` inside the function body (the parameter `n` is used as the count for permutation/direction arrays)
   - The docstring already says `n: Number of agents` -- update to `n_agents: Number of agents`

2. **cogrid/core/grid.py** line ~112:
   `def set(self, row: int, col: int, v: GridObj | None) -> None` -> `def set(self, row: int, col: int, obj: GridObj | None) -> None`
   - Update all references to `v` in the method body (likely just `self.grid[row, col] = v` -> `self.grid[row, col] = obj` or similar)

3. **cogrid/tests/test_reward_parity.py** line ~63:
   `def _dict_to_sv(d)` -> `def _dict_to_sv(fields)`
   - Update all references to `d` in the function body

**Terminology standardization (num_agents -> n_agents in parameter names):**

4. **cogrid/core/grid_object_base.py** line ~173:
   `def __init__(self, agent, num_agents: int, scope: str = "global")` -> `def __init__(self, agent, n_agents: int, scope: str = "global")`
   - Update the body reference on line ~211: `hue = (agent.agent_number - 1) * (360 / num_agents)` -> `(360 / n_agents)`

5. **cogrid/cogrid_env.py** line ~751:
   The call site: `agent, num_agents=self.config["num_agents"], scope=self.scope` -> `agent, n_agents=self.config["num_agents"], scope=self.scope`
   - This is the keyword argument at the call site -- it must match the new parameter name `n_agents`

IMPORTANT: The config dict KEY `"num_agents"` is a user-facing configuration string used in config dicts, __init__.py, test files, examples, and goal_seeking.py. Do NOT rename the config dict key -- that would break the user API. Only the function PARAMETER name changes from `num_agents` to `n_agents`. The config dict access pattern `config["num_agents"]` stays as-is everywhere.
  </action>
  <verify>
Run: `python -m pytest cogrid/tests/ -x -q` -- all tests pass.
Run: `python -m pytest cogrid/test_overcooked_env.py -x -q` -- overcooked tests pass.
Verify single-letter params eliminated: `grep -nP 'def .*\b[a-z]\b\s*[,=\)]' --include='*.py' -r cogrid/` should only show rendering geometry functions and loop-variable-style parameters.
  </verify>
  <done>No single-letter parameters in function signatures outside rendering geometry conventions. AgentObj constructor uses `n_agents` matching internal convention. All tests pass.</done>
</task>

</tasks>

<verification>
1. `grep -rP 'def [^(]*\(\s*[^)]*\b[a-z]\b\s*[,=\)]' --include='*.py' cogrid/` -- only hits are rendering geometry functions (x, y, r, cx, cy, a, b, c) and h, s, v in _hsv_to_rgb
2. `python -m pytest cogrid/tests/ -x -q` passes all tests
3. `python -m pytest cogrid/test_overcooked_env.py -x -q` passes overcooked tests
4. `grep -rn 'num_agents' --include='*.py' cogrid/core/` -- only hits are config dict key accesses `config["num_agents"]`, not parameter names
</verification>

<success_criteria>
- No single-letter parameter names in function signatures except rendering geometry conventions and _hsv_to_rgb
- `num_agents` does not appear as a function parameter name anywhere (only as a config dict key string)
- All existing tests pass without modification to assertions
</success_criteria>

<output>
After completion, create `.planning/phases/23-naming-consistency/23-02-SUMMARY.md`
</output>
