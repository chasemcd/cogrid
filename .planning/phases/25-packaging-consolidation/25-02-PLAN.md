---
phase: 25-packaging-consolidation
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - cogrid/**/*.py
autonomous: true

must_haves:
  truths:
    - "`ruff check cogrid/` exits 0 with zero violations"
    - "`ruff format --check cogrid/` exits 0 with zero files needing reformatting"
    - "All existing tests pass after lint/format fixes"
    - "The 4 F821 bugs (undefined names in run_interactive.py and layout_parser.py) are fixed"
  artifacts:
    - path: "cogrid/**/*.py"
      provides: "All Python files pass ruff check and ruff format"
  key_links:
    - from: "pyproject.toml"
      to: "ruff"
      via: "[tool.ruff] configuration"
      pattern: "select = \\[\"E\", \"F\", \"I\", \"UP\", \"D\"\\]"
---

<objective>
Fix all ruff lint and format violations across the entire cogrid codebase so that `ruff check cogrid/` and `ruff format --check cogrid/` both pass cleanly. This covers ~440 violations (E, F, I, UP, D rules at 100-char line length with Google docstring convention) across 66 Python files.

Purpose: Clean slate for linting from day one -- all future PRs will be validated against these rules in CI (Phase 26).
Output: Zero ruff violations, zero formatting issues, all tests passing.
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-packaging-consolidation/25-RESEARCH.md
@.planning/phases/25-packaging-consolidation/25-CONTEXT.md
@.planning/phases/25-packaging-consolidation/25-01-SUMMARY.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run ruff format and auto-fix, then fix F821/F841 bugs</name>
  <files>
    cogrid/**/*.py
  </files>
  <action>
**Step 1: Run ruff format on all files.**

```bash
ruff format cogrid/
```

This reformats all 66 Python files to match the 100-char line length and ruff's formatting rules. This is safe and deterministic -- it produces consistent output regardless of starting format.

**Step 2: Run ruff auto-fix for safe violations.**

```bash
ruff check cogrid/ --fix
```

This auto-fixes ~97 violations including:
- I001 (unsorted imports) -- ~67 violations, all auto-fixable
- D212 (multi-line summary first line) -- ~14 violations, auto-fixable
- D202 (blank after function) -- ~8 violations, auto-fixable
- UP008/UP034 and other pyupgrade fixes

**IMPORTANT:** After auto-fix, verify that `# noqa: F401` comments are preserved. The codebase uses side-effect imports (e.g., `import cogrid.envs  # noqa: F401`) that must not be removed by F401 auto-fix.

**Step 3: Fix 4 F821 (undefined name) bugs manually.**

These are real bugs found by ruff:

1. `cogrid/core/layout_parser.py:69` -- `EnvState` used as return type annotation but never imported. Fix: The annotation is already a string literal (`"EnvState"`) so this is likely fine with ruff. If ruff flags it, add a `from __future__ import annotations` at the top, or use `TYPE_CHECKING` import:
   ```python
   from __future__ import annotations
   ```
   OR if `EnvState` is used at runtime, add: `from cogrid.backend.env_state import EnvState`

2. `cogrid/run_interactive.py:17` -- `ort.InferenceSession` referenced but `ort` (onnxruntime) never imported. Fix: Add a try/except import block:
   ```python
   try:
       import onnxruntime as ort
   except ImportError:
       ort = None
   ```

3. `cogrid/run_interactive.py:24` -- `special.softmax` referenced but `special` (scipy.special) never imported. Fix: Add a try/except import block:
   ```python
   try:
       from scipy import special
   except ImportError:
       special = None
   ```

4. `cogrid/run_interactive.py:65` -- Same `ort` issue (second usage). Fixed by the import in item 2.

**Step 4: Fix F841 (unused variable) violations.**

Research reports 11 F841 violations. Review each one:
- If the variable is truly unused, remove the assignment or replace with `_`.
- If it is used for side effects (e.g., unpacking), keep it with a `_` prefix.
- Common pattern: `x, y = some_tuple` where only `y` is used -> `_, y = some_tuple`.

**Step 5: Run ruff check to see remaining violations.**

```bash
ruff check cogrid/ --statistics
```

This shows the count of violations remaining after auto-fix. The remaining violations will be D-rule docstring issues, E501 line length, and misc manual fixes -- handled in Task 2.

**Step 6: Run tests to verify no regressions.**

```bash
python -m pytest cogrid/tests/ -x -q
```

Auto-fix and formatting should not change behavior, but verify. If tests fail after auto-fix, check for removed side-effect imports (F401 auto-fix removing noqa'd imports).
  </action>
  <verify>
```bash
# F821 violations gone
ruff check cogrid/ --select F821 2>&1  # Should show 0 violations

# F841 violations gone
ruff check cogrid/ --select F841 2>&1  # Should show 0 violations

# Format clean
ruff format --check cogrid/ 2>&1  # Should show 0 files

# Tests pass
python -m pytest cogrid/tests/ -x -q 2>&1 | tail -5
```
  </verify>
  <done>
    - All files formatted consistently (ruff format)
    - All auto-fixable violations fixed (I001, D212, D202, UP*, etc.)
    - 4 F821 bugs fixed with proper imports
    - 11 F841 unused variables resolved
    - Tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix remaining manual violations (D-rules, E501, misc)</name>
  <files>
    cogrid/**/*.py
  </files>
  <action>
After Task 1, the remaining violations are primarily:

**D-rule docstring violations (~200+ remaining after per-file-ignores):**

- **D100 (missing module docstring):** Add a one-line module docstring to each `__init__.py` and production module that lacks one. Keep docstrings concise per project convention ("Docstring must add information the function signature does not already convey"). For `__init__.py` files, a simple package description is sufficient.

- **D101 (missing class docstring):** Add a one-line docstring to each public class. Focus on WHAT the class represents, not HOW it works.

- **D102 (missing method docstring):** Add docstrings to public methods. Per Phase 24 convention, only add docstrings that convey information beyond the method signature. For trivial methods (getters, standard overrides), a one-liner is fine.

- **D103 (missing function docstring):** Add docstrings to public functions. Same conciseness rule.

- **D107 (missing __init__ docstring):** Add docstrings to `__init__` methods in production code. One-liner describing what the constructor sets up.

- **D205 (blank line required after summary):** For multi-line docstrings, ensure there is a blank line between the summary line and the body.

- **D415 (missing period at end of first line):** Add terminal periods to docstring first lines that lack them. ~23 violations.

- **D200 (one-line docstrings should fit on one line):** Collapse single-sentence docstrings that are unnecessarily spread across multiple lines.

- **D209 (multi-line docstring closing on own line):** Move closing `"""` to its own line for multi-line docstrings.

- **D402, D403, D416, D417:** Various Google-style docstring formatting fixes. Follow Google convention strictly.

**E501 (line too long) ~47 violations:**

Rewrap lines exceeding 100 characters. Common fixes:
- Break long strings at natural boundaries
- Break long function calls across lines
- Break long imports (though ruff format usually handles this)
- For long comments, rewrap text

**E402 (module-level import not at top):**

Fix import ordering issues that auto-fix did not resolve. Typically involves moving imports above code.

**E722 (bare except):**

Replace `except:` with `except Exception:` or a more specific exception type.

**Other F-rules (F401, F402):**

- F401 (unused import): Remove unused imports that DON'T have `# noqa: F401`. Verify side-effect imports are preserved.
- F402 (import shadowed): Fix import aliasing issues.

**Strategy for D-rule fixes:**

Work through files in directory order:
1. `cogrid/__init__.py` and `cogrid/cogrid_env.py`
2. `cogrid/core/*.py` (the core modules -- most important)
3. `cogrid/envs/**/*.py` (environment modules)
4. `cogrid/feature_space/*.py`
5. `cogrid/rendering/*.py`
6. `cogrid/run_interactive.py`

For each file:
- Read the file
- Add missing docstrings (D100-D107) using Google style
- Fix docstring formatting (D200, D205, D209, D415, D402, D403, D416, D417)
- Fix E501 line-length issues
- Fix any remaining E/F/UP issues

**Google docstring style reference:**

```python
def function_name(arg1: str, arg2: int) -> bool:
    """One-line summary ending with a period.

    Longer description if needed. Only include Args/Returns
    sections if they add information beyond the type hints.

    Args:
        arg1: Description only if type hint is insufficient.

    Returns:
        True if condition met.
    """
```

**CRITICAL:** Do not add verbose Args/Returns sections that merely restate parameter names and types. Per Phase 24 decision: "Removed all Args/Returns/Parameters sections from production docstrings that merely restated param names/types." Keep docstrings concise.

**After all fixes, run final verification:**

```bash
ruff check cogrid/
ruff format --check cogrid/
python -m pytest cogrid/tests/ -x -q
```

ALL THREE must pass cleanly (exit 0).
  </action>
  <verify>
```bash
# Zero lint violations
ruff check cogrid/ 2>&1  # Exit 0, no output

# Zero format violations
ruff format --check cogrid/ 2>&1  # "0 files would be reformatted"

# Tests pass
python -m pytest cogrid/tests/ -x -q 2>&1 | tail -5

# Statistics confirm zero
ruff check cogrid/ --statistics 2>&1  # Empty or "0 violations"
```
  </verify>
  <done>
    - `ruff check cogrid/` exits 0 with zero violations
    - `ruff format --check cogrid/` exits 0 with zero files needing changes
    - All existing tests pass without modification to assertions
    - All 66 Python files comply with E+F+I+UP+D rules (Google convention, 100-char line length)
  </done>
</task>

</tasks>

<verification>
1. `ruff check cogrid/` exits 0 -- zero violations across all E, F, I, UP, D rules
2. `ruff format --check cogrid/` exits 0 -- zero files need reformatting
3. `python -m pytest cogrid/tests/ -x -q` passes -- no test regressions from lint fixes
4. `ruff check cogrid/ --statistics` shows empty output (no violations in any category)
5. The 4 F821 undefined name bugs are fixed with proper imports
</verification>

<success_criteria>
- Zero ruff check violations on the entire cogrid/ directory
- Zero ruff format violations on the entire cogrid/ directory
- All existing tests pass
- Docstrings follow Google convention throughout
- No lines exceed 100 characters
- Clean slate: every future PR starts from zero violations baseline
</success_criteria>

<output>
After completion, create `.planning/phases/25-packaging-consolidation/25-02-SUMMARY.md`
</output>
