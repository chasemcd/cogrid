---
phase: 05-environment-serialization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/envs/overcooked/test_state_serialization.py
autonomous: true

must_haves:
  truths:
    - "A terminated agent remains terminated after get_state/set_state roundtrip"
    - "The active agents list excludes terminated agents after restoration"
    - "An environment restored near max_steps truncates at the correct timestep"
  artifacts:
    - path: "cogrid/envs/overcooked/test_state_serialization.py"
      provides: "Environment termination/truncation verification tests"
      contains: "test_terminated_agent_preserved"
  key_links:
    - from: "test_terminated_agent_preserved"
      to: "Agent.terminated"
      via: "env.env_agents[0].terminated = True -> roundtrip -> verify still True"
      pattern: "env_agents.*terminated.*True"
---

<objective>
Verify environment-level termination and truncation flags are correctly preserved through state serialization.

Purpose: Research confirmed ENVR-01 (timestep) and ENVR-02 (RNG state) are already implemented and tested. ENVR-03 (termination/truncation flags) is implemented but lacks explicit test coverage. This plan adds tests to complete ENVR-03 verification.

Output: New test methods in `test_state_serialization.py` verifying termination and truncation behavior after state restoration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-environment-serialization/05-RESEARCH.md
@cogrid/envs/overcooked/test_state_serialization.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add termination and truncation verification tests</name>
  <files>cogrid/envs/overcooked/test_state_serialization.py</files>
  <action>
Add a new test class `TestEnvironmentTerminationSerialization` to the existing test file with two test methods:

1. `test_terminated_agent_preserved`:
   - Use the existing `TestSimpleEnvStateSerialization` config pattern
   - After reset, manually set `self.env.env_agents[0].terminated = True`
   - Save state via `get_state()`
   - Verify `state["agents"][0]["terminated"]` is True in serialized state
   - Restore to new environment via `set_state()`
   - Assert `env2.env_agents[0].terminated` is True
   - Assert agent 0 is NOT in `env2.agents` (the active agents list)

2. `test_truncation_after_restore_near_max_steps`:
   - Create environment with low max_steps (e.g., 10) for easy testing
   - Step to t=9 (one step from truncation)
   - Save state, verify `state["timestep"]` == 9
   - Restore to new environment
   - Assert `env2.t == 9`
   - Take one more step, assert truncateds dict has True values

Reference the existing test patterns in the file for config setup and assertion style. Place the new class after `TestEdgeCases` and before `TestAgentSerializationRoundtrip`.
  </action>
  <verify>
Run: `python -m pytest cogrid/envs/overcooked/test_state_serialization.py -v`
- All existing tests pass (31 tests)
- Two new tests exist and pass:
  - `TestEnvironmentTerminationSerialization::test_terminated_agent_preserved`
  - `TestEnvironmentTerminationSerialization::test_truncation_after_restore_near_max_steps`
- Total: 33 tests passing
  </verify>
  <done>
ENVR-03 is verified: terminated agents remain terminated and truncation fires at correct timestep after state restoration.
  </done>
</task>

</tasks>

<verification>
1. Run full test suite: `python -m pytest cogrid/envs/overcooked/test_state_serialization.py -v`
2. Verify 33 tests pass (31 existing + 2 new)
3. Confirm new test class `TestEnvironmentTerminationSerialization` exists
4. Confirm tests explicitly exercise the termination flag through roundtrip
</verification>

<success_criteria>
- [ ] `test_terminated_agent_preserved` exists and passes
- [ ] `test_truncation_after_restore_near_max_steps` exists and passes
- [ ] All 31 existing tests still pass
- [ ] Total test count: 33
- [ ] Requirements ENVR-01, ENVR-02, ENVR-03 all verified complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-environment-serialization/05-01-SUMMARY.md`
</output>
