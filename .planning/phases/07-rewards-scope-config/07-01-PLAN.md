---
phase: 07-rewards-scope-config
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/envs/overcooked/array_rewards.py
  - cogrid/core/jax_step.py
autonomous: true

must_haves:
  truths:
    - "delivery_reward, onion_in_pot_reward, soup_in_dish_reward each exist as a single function using xp -- no _array or _jax suffix variants"
    - "compute_rewards exists as a single function using xp, replacing compute_rewards_jax"
    - "_compute_fwd_positions exists as a single helper using xp, replacing _compute_fwd_positions_jax"
    - "jax_step.py calls compute_rewards (not compute_rewards_jax) and has zero lax.fori_loop calls"
    - "Zero int() casts exist in any reward function"
    - "Zero import jax.numpy as jnp statements exist in array_rewards.py"
  artifacts:
    - path: "cogrid/envs/overcooked/array_rewards.py"
      provides: "3 unified reward functions + compute_rewards orchestrator + _compute_fwd_positions helper"
      contains: "def delivery_reward"
    - path: "cogrid/core/jax_step.py"
      provides: "jax_step using unified compute_rewards, no lax.fori_loop"
      contains: "from cogrid.envs.overcooked.array_rewards import compute_rewards"
  key_links:
    - from: "cogrid/core/jax_step.py"
      to: "cogrid/envs/overcooked/array_rewards.compute_rewards"
      via: "import and call in step f. Rewards section"
      pattern: "from cogrid.envs.overcooked.array_rewards import compute_rewards"
    - from: "cogrid/envs/overcooked/array_rewards.py"
      to: "cogrid.backend.xp"
      via: "function-level import in every reward function and helper"
      pattern: "from cogrid.backend import xp"
---

<objective>
Unify all Overcooked reward functions from 6 function pairs (3 _array + 3 _jax) into 3 single functions using `xp`, plus unify compute_rewards_jax into compute_rewards, and update jax_step.py to use unified rewards and replace the last lax.fori_loop.

Purpose: Eliminates all remaining duplicate reward function pairs, achieving single code path for rewards on both backends. Also removes the last `lax` primitive from the step pipeline.
Output: Rewritten `cogrid/envs/overcooked/array_rewards.py` (~200 lines, down from ~535), updated `cogrid/core/jax_step.py`.
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-rewards-scope-config/07-RESEARCH.md
@cogrid/envs/overcooked/array_rewards.py
@cogrid/core/jax_step.py
@cogrid/core/array_rewards.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unify reward functions in array_rewards.py</name>
  <files>cogrid/envs/overcooked/array_rewards.py</files>
  <action>
Rewrite `cogrid/envs/overcooked/array_rewards.py` to contain only unified functions. The JAX variants ARE the correct unified implementations -- replace `import jax.numpy as jnp` with function-level `from cogrid.backend import xp` and rename. Delete all `_array` variants, `_find_pot_index`, and old `_jax` variants.

The file should contain exactly these functions (in order):

1. `_compute_fwd_positions(prev_state)` -- renamed from `_compute_fwd_positions_jax`. Uses `from cogrid.backend import xp` inside function body. Returns `(fwd_pos, fwd_r, fwd_c, in_bounds, fwd_types)`. Direction vector table built with `xp.array([[0,1],[1,0],[0,-1],[-1,0]], dtype=xp.int32)`.

2. `delivery_reward(prev_state, state, actions, type_ids, n_agents, coefficient=1.0, common_reward=True, action_pickup_drop_idx=4)` -- adapted from `delivery_reward_jax`. Uses `_compute_fwd_positions` (not `_compute_fwd_positions_jax`). All `jnp.` calls become `xp.` via function-level import. No Python loops, no `int()` casts.

3. `onion_in_pot_reward(prev_state, state, actions, type_ids, n_agents, coefficient=0.1, common_reward=False, action_pickup_drop_idx=4)` -- adapted from `onion_in_pot_reward_jax`. Uses vectorized pot position matching pattern (broadcasting `pot_positions[None,:,:] == agent_fwd[:,None,:]`). No `_find_pot_index` calls.

4. `soup_in_dish_reward(prev_state, state, actions, type_ids, n_agents, coefficient=0.3, common_reward=False, action_pickup_drop_idx=4)` -- adapted from `soup_in_dish_reward_jax`. Uses vectorized pot position matching.

5. `compute_rewards(prev_state, state, actions, reward_config)` -- renamed from `compute_rewards_jax`. The fn_map maps to the unified function names: `{"delivery": delivery_reward, "onion_in_pot": onion_in_pot_reward, "soup_in_dish": soup_in_dish_reward}`. Uses `xp.zeros` instead of `jnp.zeros`.

6. Add a transitional backward-compat alias at the end of the file: `compute_rewards_jax = compute_rewards` (per research recommendation, for callers that import the old name during migration).

Delete entirely:
- `delivery_reward_array`, `onion_in_pot_reward_array`, `soup_in_dish_reward_array`
- `delivery_reward_jax`, `onion_in_pot_reward_jax`, `soup_in_dish_reward_jax`
- `_compute_fwd_positions_jax`
- `_find_pot_index`
- `from cogrid.core.agent import get_dir_vec_table` import (no longer needed -- unified version builds dir_vec_table inline with `xp.array`)

Update module docstring to reflect the unified approach (remove references to "Numpy-path" and "JAX-path" variants).

Verification checklist for the code:
- Every function body starts with `from cogrid.backend import xp` (function-level, NOT module-level)
- Zero occurrences of `import jax.numpy as jnp` or `import jax`
- Zero occurrences of `int(` anywhere in the file
- Zero occurrences of `_jax` or `_array` in function names (except the backward-compat alias)
- All `jnp.` replaced with `xp.`
  </action>
  <verify>
Run: `python -c "from cogrid.envs.overcooked.array_rewards import delivery_reward, onion_in_pot_reward, soup_in_dish_reward, compute_rewards, compute_rewards_jax; print('All imports OK')"` -- should print "All imports OK".

Run: `grep -c 'int(' cogrid/envs/overcooked/array_rewards.py` -- should return 0 (or only in dtype specs like `int32`, not `int(` as a cast).

Run: `grep -c 'import jax' cogrid/envs/overcooked/array_rewards.py` -- should return 0.

Run: `grep -c '_find_pot_index' cogrid/envs/overcooked/array_rewards.py` -- should return 0.
  </verify>
  <done>
`cogrid/envs/overcooked/array_rewards.py` contains exactly 5 functions + 1 alias (~200 lines), all using `from cogrid.backend import xp`, with zero `int()` casts, zero `jax` imports, and zero `_array`/`_jax` suffix function definitions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update jax_step.py to use unified rewards and eliminate lax.fori_loop</name>
  <files>cogrid/core/jax_step.py</files>
  <action>
Make two changes to `cogrid/core/jax_step.py`:

**Change 1: Replace lax.fori_loop with set_at_2d loop (lines 151-158)**

In the tick handler section of `jax_step()`, replace:
```python
def set_pot_state_fn(i, osm):
    r = pot_positions[i, 0]
    c = pot_positions[i, 1]
    return osm.at[r, c].set(pot_state[i])
osm = lax.fori_loop(0, n_pots, set_pot_state_fn, osm)
```

With:
```python
from cogrid.backend.array_ops import set_at_2d
for p in range(n_pots):
    osm = set_at_2d(osm, pot_positions[p, 0], pot_positions[p, 1], pot_state[p])
```

This matches the established pattern from `process_interactions()` (06-02) and `get_all_agent_obs()` (06-03). n_pots is a static shape dimension (1-2 in Overcooked layouts), so the Python loop unrolls at trace time and is JIT-compatible.

**Change 2: Update reward import (line 134)**

Replace:
```python
from cogrid.envs.overcooked.array_rewards import compute_rewards_jax
```
With:
```python
from cogrid.envs.overcooked.array_rewards import compute_rewards
```

And update the call site (line 226):
```python
rewards = compute_rewards(prev_dict, state_dict, actions, reward_config)
```

**Change 3: Remove unused lax import**

After removing the lax.fori_loop, check if `import jax.lax as lax` on line 130 is still needed. It IS still needed for `lax.stop_gradient` calls later in the function (lines 232-234). Keep the import but update the module docstring references from `compute_rewards_jax` to `compute_rewards`.

Also update the `jax_reset` function: it uses `lax.stop_gradient` on line 335, so the `lax` import in `jax_reset` (line 282) is still needed. Leave it.

Update the module docstring (lines 1-30): change references to `compute_rewards_jax` to `compute_rewards`.
  </action>
  <verify>
Run: `python -c "from cogrid.core.jax_step import jax_step; print('jax_step import OK')"` -- should succeed.

Run: `grep -c 'fori_loop' cogrid/core/jax_step.py` -- should return 0.

Run: `grep -c 'compute_rewards_jax' cogrid/core/jax_step.py` -- should return 0.

Run: `grep 'compute_rewards' cogrid/core/jax_step.py` -- should show `from cogrid.envs.overcooked.array_rewards import compute_rewards` and `rewards = compute_rewards(`.

Run the jax_step smoke test: `python cogrid/core/jax_step.py` -- should print "SMOKE TEST PASSED".
  </verify>
  <done>
`jax_step.py` imports `compute_rewards` (not `compute_rewards_jax`), uses `set_at_2d` loop instead of `lax.fori_loop` for pot state writeback, and the end-to-end JIT smoke test passes (reset + 11 steps without error).
  </done>
</task>

</tasks>

<verification>
1. `python -c "from cogrid.envs.overcooked.array_rewards import delivery_reward, onion_in_pot_reward, soup_in_dish_reward, compute_rewards"` succeeds
2. `grep -rn 'fori_loop' cogrid/core/jax_step.py` returns no matches
3. `grep -rn 'compute_rewards_jax' cogrid/core/jax_step.py` returns no matches
4. `grep -rn 'int(' cogrid/envs/overcooked/array_rewards.py | grep -v int32 | grep -v 'int,'` returns no matches (no int() casts outside dtype refs)
5. `grep -rn 'import jax' cogrid/envs/overcooked/array_rewards.py` returns no matches
6. `python cogrid/core/jax_step.py` smoke test passes end-to-end
</verification>

<success_criteria>
- 6 old reward functions deleted, replaced by 3 unified functions using xp
- _find_pot_index deleted, _compute_fwd_positions_jax renamed to _compute_fwd_positions
- compute_rewards_jax renamed to compute_rewards (with backward-compat alias)
- jax_step.py uses set_at_2d loop instead of lax.fori_loop
- End-to-end JIT smoke test passes
</success_criteria>

<output>
After completion, create `.planning/phases/07-rewards-scope-config/07-01-SUMMARY.md`
</output>
