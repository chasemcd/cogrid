---
phase: 01-framework-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/scripts/audit_serialization.py
autonomous: true

must_haves:
  truths:
    - "Developer can run a script and see all GridObj subclasses listed"
    - "Each subclass shows serialization status (STATELESS, IMPLEMENTED, MISSING)"
    - "Output shows file path and line number for each class"
  artifacts:
    - path: "cogrid/scripts/audit_serialization.py"
      provides: "Audit script for GridObj serialization status"
      min_lines: 80
  key_links:
    - from: "cogrid/scripts/audit_serialization.py"
      to: "cogrid/**/*.py"
      via: "ast module parsing Python files"
      pattern: "ast\\.parse"
---

<objective>
Create an audit script that programmatically identifies all GridObj subclasses and their serialization implementation status.

Purpose: Enables developers to quickly identify which objects need serialization work (FRAM-01 requirement).
Output: Executable Python script at `cogrid/scripts/audit_serialization.py` that outputs categorized report.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-framework-foundation/01-RESEARCH.md

# Key reference files
@cogrid/core/grid_object.py (lines 236-275 for get_extra_state/set_extra_state pattern)
@cogrid/core/grid_object.py (lines 521-578 for Counter example)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts directory and audit script</name>
  <files>cogrid/scripts/__init__.py, cogrid/scripts/audit_serialization.py</files>
  <action>
Create a new `cogrid/scripts/` directory with `__init__.py` (empty).

Create `audit_serialization.py` with:

1. **AST-based class finder** that:
   - Recursively finds all `.py` files in cogrid/
   - Parses each file with `ast.parse()`
   - Finds all classes that inherit from `GridObj` (check base names: "GridObj", "grid_object.GridObj")
   - Also finds classes that inherit from other GridObj subclasses (multi-level inheritance)
   - For each class, detect:
     - `has_get_extra_state`: method named "get_extra_state" in class body
     - `has_set_extra_state`: method named "set_extra_state" in class body
     - `has_extra_attributes`: heuristic - look for `self.X = ` assignments in `__init__` beyond `super().__init__()` and `self.state`

2. **Status categorization**:
   - `STATELESS`: No extra attributes detected (or only standard ones like color, char, object_id)
   - `IMPLEMENTED`: Has both `get_extra_state` AND `set_extra_state` methods
   - `PARTIAL`: Has only one of the two methods
   - `MISSING`: Has extra attributes but no serialization methods

3. **Output format** (to stdout):
```
=== GridObj Serialization Audit ===

STATELESS (N):
  - ClassName (file/path.py:line)
  ...

IMPLEMENTED (N):
  - ClassName (file/path.py:line)
  ...

MISSING (N):
  - ClassName (file/path.py:line)
    Extra attributes: attr1, attr2
  ...

Summary:
  Total classes: X
  Stateless: X
  Implemented: X
  Missing: X
```

4. **CLI interface**:
   - `python -m cogrid.scripts.audit_serialization` runs the audit
   - Optional `--json` flag outputs JSON instead of formatted text
   - Optional `--path` flag to specify cogrid directory (default: auto-detect from script location)

Use a dataclass for `SerializationStatus` to hold class info.

IMPORTANT: The heuristic for "extra attributes" should exclude:
- Class-level attributes (color, char, object_id)
- `self.state` (handled by base serialization)
- `self.obj_placed_on` (standard GridObj attribute)

Focus on instance attributes set in `__init__` like:
- `self.toggle_countdown`
- `self.first_toggle_agent_id`
- `self.is_open`
- `self.is_locked`
- `self.objects_in_pot`
- `self.cooking_timer`
  </action>
  <verify>
Run `python -m cogrid.scripts.audit_serialization` from the repository root and verify:
1. Output shows categorized list of classes
2. Counter and Pot appear under IMPLEMENTED
3. RedVictim appears under MISSING (has toggle_countdown, first_toggle_agent_id)
4. Wall, Floor, Onion, Tomato appear under STATELESS
  </verify>
  <done>
Script exists at cogrid/scripts/audit_serialization.py, is executable, and correctly categorizes all 23 GridObj subclasses by serialization status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add audit script test</name>
  <files>cogrid/scripts/test_audit_serialization.py</files>
  <action>
Create a test file that verifies the audit script works correctly:

1. Test that `find_gridobj_subclasses()` function finds known classes:
   - Wall, Floor, Counter, Door, Key (from grid_object.py)
   - Onion, Pot, Plate (from overcooked_grid_objects.py)
   - GreenVictim, RedVictim (from search_rescue_grid_objects.py)

2. Test status categorization:
   - Counter should be IMPLEMENTED
   - Pot should be IMPLEMENTED
   - RedVictim should be MISSING (has extra attrs, no methods)
   - Wall should be STATELESS

3. Test that output format is valid (no crashes, contains expected sections)

Use pytest. Import functions from the audit module.
  </action>
  <verify>
Run `pytest cogrid/scripts/test_audit_serialization.py -v` and all tests pass.
  </verify>
  <done>
Test file exists and validates audit script functionality.
  </done>
</task>

</tasks>

<verification>
1. Run `python -m cogrid.scripts.audit_serialization` - outputs categorized report
2. Run `python -m cogrid.scripts.audit_serialization --json` - outputs valid JSON
3. Run `pytest cogrid/scripts/test_audit_serialization.py -v` - all tests pass
4. Verify Counter appears under IMPLEMENTED
5. Verify RedVictim appears under MISSING with extra attributes listed
</verification>

<success_criteria>
- Audit script exists and runs without errors
- Output correctly categorizes all GridObj subclasses
- Counter, Pot shown as IMPLEMENTED
- RedVictim shown as MISSING with toggle_countdown, first_toggle_agent_id listed
- Wall, Floor, Onion, etc. shown as STATELESS
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-framework-foundation/01-01-SUMMARY.md`
</output>
