---
phase: 01-framework-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/envs/search_rescue/search_rescue_grid_objects.py
  - cogrid/envs/search_rescue/test_redvictim_serialization.py
autonomous: true

must_haves:
  truths:
    - "RedVictim toggle_countdown value survives get_state/set_state roundtrip"
    - "RedVictim first_toggle_agent_id value survives roundtrip"
    - "Door is_open/is_locked state survives roundtrip (via state integer)"
  artifacts:
    - path: "cogrid/envs/search_rescue/search_rescue_grid_objects.py"
      provides: "RedVictim get_extra_state/set_extra_state implementation"
      contains: "def get_extra_state"
    - path: "cogrid/envs/search_rescue/test_redvictim_serialization.py"
      provides: "Roundtrip tests for RedVictim and Door"
      min_lines: 40
  key_links:
    - from: "RedVictim.get_extra_state"
      to: "toggle_countdown, first_toggle_agent_id"
      via: "dict serialization"
      pattern: "toggle_countdown.*first_toggle_agent_id"
---

<objective>
Implement RedVictim serialization and verify Door serialization works correctly through the state integer.

Purpose: Complete recursive serialization for objects with internal state (FRAM-02 requirement).
Output: RedVictim has working get_extra_state/set_extra_state, Door verified via tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-framework-foundation/01-RESEARCH.md

# Reference implementations
@cogrid/core/grid_object.py (lines 542-575 for Counter pattern)
@cogrid/envs/overcooked/overcooked_grid_objects.py (lines 251-280 for Pot pattern)

# Files to modify
@cogrid/envs/search_rescue/search_rescue_grid_objects.py (lines 227-271 for RedVictim)
@cogrid/core/grid_object.py (lines 612-680 for Door)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement RedVictim serialization</name>
  <files>cogrid/envs/search_rescue/search_rescue_grid_objects.py</files>
  <action>
Add `get_extra_state()` and `set_extra_state()` methods to the `RedVictim` class.

Follow the Counter pattern from grid_object.py:

```python
def get_extra_state(self, scope: str = "global") -> dict | None:
    """Serialize RedVictim's toggle countdown state.

    :param scope: The scope of the object registry (unused but kept for interface consistency).
    :type scope: str
    :return: Dictionary containing toggle state, or None if at default state.
    :rtype: dict | None
    """
    # Only serialize if not in default state
    if self.toggle_countdown == 0 and self.first_toggle_agent_id is None:
        return None

    return {
        "toggle_countdown": self.toggle_countdown,
        "first_toggle_agent_id": self.first_toggle_agent_id,
    }

def set_extra_state(self, state_dict: dict, scope: str = "global") -> None:
    """Restore RedVictim's toggle countdown state from serialization.

    :param state_dict: The dictionary returned by get_extra_state().
    :type state_dict: dict
    :param scope: The scope of the object registry (unused but kept for interface consistency).
    :type scope: str
    """
    if state_dict:
        self.toggle_countdown = state_dict.get("toggle_countdown", 0)
        self.first_toggle_agent_id = state_dict.get("first_toggle_agent_id")
```

Place these methods after the `render()` method and before the `register_object()` call.

NOTE: The research identified that RedVictim uses `self.first_toggle_agent` (without _id suffix) in the toggle method but declares `self.first_toggle_agent_id` in __init__. Check the actual code and use the correct attribute name. The toggle method at line 256 uses `self.first_toggle_agent = agent.agent_id` but line 261 uses `self.first_toggle_agent`. This appears to be a bug in the original code. Serialize whichever attribute actually exists.
  </action>
  <verify>
1. Read the modified file and confirm methods are added
2. Verify the method signatures match the base class pattern
3. Check that both methods handle None/empty state correctly
  </verify>
  <done>
RedVictim class has get_extra_state() and set_extra_state() methods that serialize toggle_countdown and the first toggle agent ID.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create serialization roundtrip tests</name>
  <files>cogrid/envs/search_rescue/test_redvictim_serialization.py</files>
  <action>
Create a test file with roundtrip tests for RedVictim and Door serialization.

Tests to include:

1. **test_redvictim_default_state_roundtrip**: Create RedVictim, verify get_extra_state returns None

2. **test_redvictim_active_countdown_roundtrip**:
   - Create RedVictim
   - Set toggle_countdown = 15
   - Set first_toggle_agent_id = "agent_0"
   - Call get_extra_state()
   - Create new RedVictim
   - Call set_extra_state() with saved state
   - Verify toggle_countdown == 15
   - Verify first_toggle_agent_id == "agent_0"

3. **test_door_locked_roundtrip**:
   - Create Door(state=0) (locked)
   - Verify is_locked == True, is_open == False
   - Get state via encode()
   - Create new Door with same state
   - Verify is_locked == True, is_open == False

4. **test_door_open_roundtrip**:
   - Create Door(state=2) (open)
   - Verify is_open == True
   - Get state via encode()
   - Create new Door with same state
   - Verify is_open == True

5. **test_door_closed_unlocked_roundtrip**:
   - Create Door(state=1) (closed, unlocked)
   - Verify is_open == False, is_locked == False
   - Roundtrip and verify

Use pytest. Import from cogrid.core.grid_object and cogrid.envs.search_rescue.search_rescue_grid_objects.

The Door tests confirm that Door correctly derives is_open/is_locked from the state integer in __init__, meaning no get_extra_state() implementation is needed for Door.
  </action>
  <verify>
Run `pytest cogrid/envs/search_rescue/test_redvictim_serialization.py -v` and all tests pass.
  </verify>
  <done>
Test file exists with roundtrip tests for RedVictim (with countdown state) and Door (all three states). All tests pass.
  </done>
</task>

</tasks>

<verification>
1. RedVictim has get_extra_state() and set_extra_state() methods
2. `pytest cogrid/envs/search_rescue/test_redvictim_serialization.py -v` passes all tests
3. RedVictim with toggle_countdown=15 roundtrips correctly
4. Door in all three states (locked/closed/open) roundtrips correctly via state integer
</verification>

<success_criteria>
- RedVictim.get_extra_state() returns dict with toggle_countdown and first_toggle_agent_id when active
- RedVictim.set_extra_state() restores those values
- Door correctly restores is_open/is_locked from state integer (no extra_state needed)
- All roundtrip tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-framework-foundation/01-02-SUMMARY.md`
</output>
