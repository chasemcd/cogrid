---
phase: 19-legacy-feature-system-removal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/feature_space/feature.py
  - cogrid/feature_space/feature_space.py
  - cogrid/feature_space/features.py
  - cogrid/feature_space/__init__.py
  - cogrid/feature_space/array_features.py
  - cogrid/envs/overcooked/overcooked_features.py
  - cogrid/envs/overcooked/overcooked_grid_objects.py
  - cogrid/envs/overcooked/overcooked_array_features.py
  - cogrid/envs/overcooked/__init__.py
  - cogrid/core/grid_object.py
  - cogrid/core/component_registry.py
  - cogrid/core/autowire.py
  - cogrid/cogrid_env.py
  - cogrid/tests/test_step_pipeline.py
  - cogrid/tests/test_overcooked_array_features.py
  - cogrid/tests/test_autowire.py
  - cogrid/test_overcooked_env.py
  - docs/content/cogrid_env.rst
autonomous: true

must_haves:
  truths:
    - "feature.py, feature_space.py, features.py no longer exist in cogrid/feature_space/"
    - "overcooked_features.py no longer exists in cogrid/envs/overcooked/"
    - "build_feature_fn is not in _COMPONENT_METHODS or _EXPECTED_SIGNATURES"
    - "has_feature_fn property does not exist on ComponentMetadata"
    - "feature_fn_builder key does not exist in scope_config output"
    - "Pot class has no build_feature_fn classmethod"
    - "build_overcooked_feature_fn monolithic function does not exist"
    - "python -m pytest cogrid/tests/ -x and python -m pytest cogrid/test_overcooked_env.py -x both exit 0"
  artifacts:
    - path: "cogrid/feature_space/__init__.py"
      provides: "Clean init with only array_features import"
    - path: "cogrid/feature_space/array_features.py"
      provides: "Bare feature functions, ArrayFeature subclasses, get_all_agent_obs -- no legacy build_feature_fn or compose_features"
    - path: "cogrid/core/component_registry.py"
      provides: "No build_feature_fn in _EXPECTED_SIGNATURES, no has_feature_fn on ComponentMetadata"
    - path: "cogrid/core/autowire.py"
      provides: "No feature_fn_builder in scope_config"
  key_links:
    - from: "cogrid/core/step_pipeline.py"
      to: "cogrid/feature_space/array_features.py"
      via: "get_all_agent_obs lazy import inside step() function body"
      pattern: "from cogrid\\.feature_space\\.array_features import get_all_agent_obs"
      note: "This import lives inside the step() function (line 139), not at module level. It MUST remain untouched."
    - from: "cogrid/core/autowire.py"
      to: "cogrid/feature_space/array_features.py"
      via: "import for registration trigger"
      pattern: "import cogrid\\.feature_space\\.array_features"
---

<objective>
Delete the old OOP feature system entirely and remove build_feature_fn from the GridObject component classmethod convention, leaving a single code path for features via ArrayFeature subclasses + autowire composition.

Purpose: Eliminate dead code paths left over from the pre-v1.3 feature system. The ArrayFeature + autowire system is now the sole feature composition path (wired in Phase 18), so the old OOP Feature/FeatureSpace classes, the monolithic build_overcooked_feature_fn, and the build_feature_fn GridObject classmethod convention are all dead weight.

Output: A codebase with exactly one feature system -- ArrayFeature subclasses composed by autowire.
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-autowire-integration-parity/18-02-SUMMARY.md
@.planning/phases/18.1-remove-environment-specific-logic-from-core-files/18.1-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete old OOP feature files and remove build_feature_fn from component convention</name>
  <files>
    cogrid/feature_space/feature.py
    cogrid/feature_space/feature_space.py
    cogrid/feature_space/features.py
    cogrid/feature_space/__init__.py
    cogrid/envs/overcooked/overcooked_features.py
    cogrid/envs/overcooked/__init__.py
    cogrid/core/grid_object.py
    cogrid/core/component_registry.py
    cogrid/core/autowire.py
    cogrid/envs/overcooked/overcooked_grid_objects.py
    cogrid/envs/overcooked/overcooked_array_features.py
    cogrid/cogrid_env.py
    docs/content/cogrid_env.rst
  </files>
  <action>
    **Delete these 4 files entirely** (git rm):
    - `cogrid/feature_space/feature.py` -- old OOP Feature base class
    - `cogrid/feature_space/feature_space.py` -- old FeatureSpace registry + make_feature_generator
    - `cogrid/feature_space/features.py` -- old OOP feature implementations (FullMapImage, FoVImage, AgentDir, etc.)
    - `cogrid/envs/overcooked/overcooked_features.py` -- old OOP Overcooked feature implementations (OvercookedCollectedFeatures, LayoutID, ClosestObj, etc.)

    **Edit `cogrid/feature_space/__init__.py`:**
    - Remove both existing import lines (`from cogrid.feature_space import feature_space` and `from cogrid.feature_space import features`)
    - Replace with a single line: `from cogrid.feature_space import array_features  # noqa: F401`
    - This is needed because `cogrid/core/autowire.py` does `import cogrid.feature_space.array_features` to trigger registration, and having the __init__ expose it is cleaner.

    **Edit `cogrid/feature_space/array_features.py`:**
    - Remove the `compose_features()` function (lines ~245-261). It is only used by the legacy `build_feature_fn()`.
    - Remove the `build_feature_fn()` function (lines ~264-328). This is the legacy monolithic feature builder. The new path is `compose_feature_fns()` in `cogrid/core/array_features.py` via autowire.
    - KEEP: all bare feature functions (`agent_pos_feature`, `agent_dir_feature`, `full_map_encoding_feature`, `can_move_direction_feature`, `inventory_feature`), all 4 ArrayFeature subclasses (`AgentDir`, `AgentPosition`, `CanMoveDirection`, `Inventory`), and `get_all_agent_obs()`.
    - Update the module docstring to remove references to `build_feature_fn()` (lines 8-10 reference "Feature composition ... is resolved at init time via build_feature_fn()").

    **Edit `cogrid/core/grid_object.py`:**
    - Remove `"build_feature_fn"` from the `_COMPONENT_METHODS` frozenset (line 45).

    **Edit `cogrid/core/component_registry.py`:**
    - Remove `"build_feature_fn": []` from `_EXPECTED_SIGNATURES` dict (line 106).
    - Remove the `has_feature_fn` property from `ComponentMetadata` (lines 56-57).

    **Edit `cogrid/core/autowire.py` in `build_scope_config_from_components()`:**
    - Remove the entire `feature_fn_builder` composition block (lines 223-233): the `feature_fn_builder = None`, the `feat_builders` list comprehension using `has_feature_fn`, the single-builder and multi-builder branches.
    - Remove `"feature_fn_builder": feature_fn_builder` from the return dict (line 247).

    **Edit `cogrid/envs/overcooked/overcooked_grid_objects.py`:**
    - Remove the `build_feature_fn` classmethod from the `Pot` class (lines 279-282). This is the classmethod that returned `build_overcooked_feature_fn`.

    **Edit `cogrid/envs/overcooked/overcooked_array_features.py`:**
    - Remove the entire `build_overcooked_feature_fn()` function (starts around line 486, ends around line 642). This is the monolithic feature builder that Phase 18 replaced with autowire composition. It spans from `def build_overcooked_feature_fn(` through `return feature_fn`.
    - KEEP everything else: all bare feature functions, all ArrayFeature subclasses, the `register_feature_order` / `register_layout_indices` calls at the bottom.
    - Remove the import of `build_overcooked_feature_fn` from any `__all__` or module-level exports if present.

    **Edit `cogrid/envs/overcooked/__init__.py`:**
    - Remove the line `from cogrid.envs.overcooked import overcooked_features` (line 1). The remaining 3 imports (overcooked_grid_objects, array_rewards, overcooked_array_features) stay.

    **Edit `cogrid/cogrid_env.py`:**
    - Remove `from cogrid.feature_space import feature_space` import (line 23).
    - Remove the entire `features` parsing block and `self.feature_spaces` / `self.observation_spaces` construction (lines 173-197). These use the old FeatureSpace class which is being deleted.
    - Remove the `get_obs()` method (lines 920-929) that delegates to `self.feature_spaces`.
    - Remove the `observation_space()` method (lines 366-374). This method returns `self.observation_spaces[agent]`, which depends on the deleted `self.observation_spaces` dict. It is not part of the PettingZoo ParallelEnv API (PettingZoo uses `observation_space(agent)` but expects it on AECEnv, not ParallelEnv; ParallelEnv uses `observation_spaces` dict directly). Grepping the codebase shows the only other reference to `observation_spaces` is in `cogrid/test_gridworld_env.py` line 143, which sets it but does not read it via this method. Removing both the dict and the method is safe.
    - IMPORTANT: The vectorized observation path (`self._feature_fn`, built in `reset()` via `build_feature_config_from_components`) is the sole observation path now and must NOT be touched. `step_pipeline.py` imports `get_all_agent_obs` from `cogrid.feature_space.array_features` inside its `step()` function body (line 139) -- do NOT modify step_pipeline.py in this task.

    **Edit `docs/content/cogrid_env.rst`:**
    - Remove the `.. automodule:: cogrid.feature_space.feature` directive (line 29).
  </action>
  <verify>
    Run: `python -c "from cogrid.feature_space import array_features; print('OK')"` -- should succeed.
    Run: `python -c "from cogrid.feature_space import feature"` -- should fail with ImportError.
    Run: `python -c "from cogrid.feature_space import feature_space"` -- should fail with ImportError.
    Run: `python -c "from cogrid.core.component_registry import ComponentMetadata; assert not hasattr(ComponentMetadata, 'has_feature_fn')"` -- should succeed.
    Run: `python -c "from cogrid.core.autowire import build_scope_config_from_components; import cogrid.envs; c = build_scope_config_from_components('overcooked'); assert 'feature_fn_builder' not in c; print('OK')"` -- should succeed.
    Run: `python -c "from cogrid.envs.overcooked.overcooked_grid_objects import Pot; assert not hasattr(Pot, 'build_feature_fn'); print('OK')"` -- should succeed (build_feature_fn no longer discovered since removed from _COMPONENT_METHODS, even if classmethod itself removed).
  </verify>
  <done>
    The 4 old OOP feature files are deleted. build_feature_fn is removed from _COMPONENT_METHODS, _EXPECTED_SIGNATURES, and ComponentMetadata. feature_fn_builder is removed from scope_config. Pot.build_feature_fn and build_overcooked_feature_fn are removed. All imports updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests, fix remaining references, and verify all tests pass</name>
  <files>
    cogrid/tests/test_step_pipeline.py
    cogrid/tests/test_overcooked_array_features.py
    cogrid/tests/test_autowire.py
    cogrid/test_overcooked_env.py
  </files>
  <action>
    **Edit `cogrid/tests/test_step_pipeline.py`:**
    - Three locations import `from cogrid.feature_space.array_features import build_feature_fn` (lines 31, 205, 305). Replace these with the autowire path: `from cogrid.core.autowire import build_feature_config_from_components`.
    - At each call site, replace `build_feature_fn(feature_names, scope="overcooked")` with:
      ```python
      feature_config = build_feature_config_from_components("overcooked", n_agents=n_agents)
      feature_fn = feature_config["feature_fn"]
      ```
      where `n_agents` is available in the test context (it comes from `array_state["n_agents"]`).
    - Remove the `feature_names` list at each site since it is no longer needed (the autowire discovers features from the registry).

    **Edit `cogrid/tests/test_overcooked_array_features.py`:**
    - Remove `test_autowire_provides_feature_fn_builder` (lines 277-289). This test validated that Pot.build_feature_fn appeared in scope_config, which is being deleted.
    - Remove `test_generic_scope_has_no_feature_fn_builder` (lines 292-297). Same reason.

    **Edit `cogrid/tests/test_autowire.py`:**
    - Remove `"feature_fn_builder"` from the `required_keys` set (line 55). The scope_config no longer includes this key.

    **Edit `cogrid/test_overcooked_env.py`:**
    The file is 360 lines. Analysis of its contents:
    - Lines 11-14: 4 imports of old feature modules (`feature`, `features`, `feature_space`, `overcooked_features`).
    - Lines 32-154: `NAgentOvercookedFeatureSpace` class -- an old OOP Feature subclass that uses `features.AgentDir()`, `overcooked_features.OvercookedInventory()`, etc. This is dead code; the ArrayFeature system replaces it entirely.
    - Line 152-154: `feature_space.register_feature(...)` call -- registers the old OOP feature class.
    - Lines 157-182: `N_agent_overcooked_config` dict and `make_env()` helper. The config has `"features": "n_agent_overcooked_features"` which references the old OOP feature. However, `make_env()` is used by all the test cases below.
    - Lines 189-360: `TestOvercookedEnv` class with 6 test methods: `test_tomato_in_pot`, `test_cooking_tomato_soup`, `test_pot_can_place_on`, `test_delivery_zone_can_place_on`, `test_random_actions`, and helper `pick_tomato_and_move_to_pot`. These tests exercise grid object interaction mechanics (pot placement, cooking, delivery) -- NOT the feature system. They are unique and valuable; no equivalent tests exist in `cogrid/tests/`.

    Concrete actions:
    1. Delete the 4 old feature imports (lines 11-14).
    2. Delete the entire `NAgentOvercookedFeatureSpace` class (lines 32-125).
    3. Delete the `feature_space.register_feature(...)` call (lines 152-154).
    4. In `N_agent_overcooked_config` (line 157), remove the `"features": "n_agent_overcooked_features"` key-value pair. The vectorized feature system (autowire) does not use this config key; it uses `scope` + `build_feature_config_from_components` instead.
    5. KEEP `make_env()` and all 6 test methods in `TestOvercookedEnv` intact -- they test grid object mechanics, not features.
    6. Verify no remaining references to `feature`, `features`, `feature_space`, or `overcooked_features` remain in the file.

    **Final verification:**
    Run the full test suite: `python -m pytest cogrid/tests/ -x -v` to confirm all tests pass.
    Also run: `python -m pytest cogrid/test_overcooked_env.py -x -v` (this file is outside cogrid/tests/).
    If any test failures arise from the removed imports/code, fix them.
  </action>
  <verify>
    Run: `python -m pytest cogrid/tests/ -x -v` -- all tests pass.
    Run: `python -m pytest cogrid/test_overcooked_env.py -x -v` -- all tests pass.
    Run: `grep -r "feature_fn_builder" cogrid/ --include="*.py"` -- zero matches.
    Run: `grep -r "from cogrid.feature_space import feature_space" cogrid/ --include="*.py"` -- zero matches.
    Run: `grep -r "from cogrid.feature_space import features" cogrid/ --include="*.py"` -- zero matches.
    Run: `grep -r "from cogrid.feature_space import feature" cogrid/ --include="*.py"` -- zero matches (note: `from cogrid.feature_space import array_features` should still exist).
  </verify>
  <done>
    All tests pass. No references to the old feature system remain. The codebase has a single code path for features: ArrayFeature subclasses composed by autowire.
  </done>
</task>

</tasks>

<verification>
1. `feature.py`, `feature_space.py`, `features.py` do NOT exist in `cogrid/feature_space/`
2. `overcooked_features.py` does NOT exist in `cogrid/envs/overcooked/`
3. `build_feature_fn` is NOT in `_COMPONENT_METHODS` (grid_object.py) or `_EXPECTED_SIGNATURES` (component_registry.py)
4. `has_feature_fn` property does NOT exist on `ComponentMetadata`
5. `feature_fn_builder` key does NOT exist in scope_config returned by `build_scope_config_from_components`
6. `Pot` class has NO `build_feature_fn` classmethod
7. `build_overcooked_feature_fn` function does NOT exist in overcooked_array_features.py
8. `python -m pytest cogrid/tests/ -x` passes all tests
9. `grep -r "feature_fn_builder\|from cogrid.feature_space import feature_space\|from cogrid.feature_space import features\|from cogrid.feature_space import feature[^s]" cogrid/ --include="*.py"` returns zero matches
</verification>

<success_criteria>
- The old OOP feature system is completely deleted (CLNP-01, CLNP-02)
- build_feature_fn is removed from the GridObject component classmethod convention (CLNP-03)
- All tests pass with zero behavioral regression (CLNP-04)
- The codebase has exactly one feature code path: ArrayFeature subclasses + autowire composition
</success_criteria>

<output>
After completion, create `.planning/phases/19-legacy-feature-system-removal/19-01-SUMMARY.md`
</output>
