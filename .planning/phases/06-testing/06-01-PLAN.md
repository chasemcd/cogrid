---
phase: 06-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/envs/search_rescue/test_sr_env_serialization.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Search & Rescue environment can be saved and restored after multiple steps"
    - "Restored S&R environment has identical timestep, agent positions, and grid state"
    - "RedVictim mid-rescue state survives full environment roundtrip"
    - "S&R environment correctly terminates after restoration when all victims rescued"
  artifacts:
    - path: "cogrid/envs/search_rescue/test_sr_env_serialization.py"
      provides: "S&R environment integration tests parallel to Overcooked tests"
      min_lines: 120
      contains: "class TestSearchRescueEnvSerialization"
  key_links:
    - from: "test_sr_env_serialization.py"
      to: "cogrid_env.CoGridEnv.get_state/set_state"
      via: "full environment roundtrip"
      pattern: "(get_state|set_state)"
    - from: "test_sr_env_serialization.py"
      to: "SearchRescue-Test-V0"
      via: "registry.make"
      pattern: "registry\\.make.*SearchRescue"
---

<objective>
Create Search & Rescue environment integration tests that mirror the Overcooked environment tests.

Purpose: Fill the TEST-02 gap - S&R has only object-level tests, no environment-level roundtrip tests
Output: New test file `cogrid/envs/search_rescue/test_sr_env_serialization.py` with 5-6 tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-testing/06-RESEARCH.md

# Existing test patterns to follow
@cogrid/envs/overcooked/test_state_serialization.py (lines 225-395 - TestOvercookedStateSerialization class)

# S&R environment and registered config
@cogrid/envs/search_rescue/search_rescue.py
@cogrid/envs/__init__.py (lines 163-194 - sr_config and layout)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create S&R environment integration test file</name>
  <files>cogrid/envs/search_rescue/test_sr_env_serialization.py</files>
  <action>
Create test file with TestSearchRescueEnvSerialization class following the established patterns from TestOvercookedStateSerialization.

Include tests:
1. `test_basic_get_state` - Verify get_state returns dict with expected keys
2. `test_roundtrip_after_reset` - Save/restore immediately after reset, verify agent positions and grid match
3. `test_roundtrip_after_steps` - Run 10 steps, save, restore, verify timestep and grid encoding match
4. `test_redvictim_mid_rescue_roundtrip` - Set up RedVictim with active countdown (toggle_countdown=15, first_toggle_agent="agent_0"), save state mid-rescue, restore to new env, verify countdown and agent are preserved
5. `test_agent_with_medkit_roundtrip` - Give agent a MedKit in inventory, roundtrip, verify inventory restored

Use pytest style (not unittest) for consistency with existing S&R test files.
Use the existing "SearchRescue-Test-V0" registered environment which uses "search_rescue_test" layout.
Import from cogrid.envs.registry to get the environment.

Pattern to follow:
```python
import pytest
import numpy as np
from cogrid.core.actions import Actions
from cogrid.envs import registry
from cogrid.envs.search_rescue.search_rescue_grid_objects import RedVictim, MedKit

class TestSearchRescueEnvSerialization:
    """Test state serialization for Search & Rescue environments."""

    @pytest.fixture
    def env(self):
        """Create a Search & Rescue test environment."""
        env = registry.make("SearchRescue-Test-V0")
        return env

    def test_roundtrip_after_steps(self, env):
        env.reset(seed=42)
        actions = {0: Actions.MoveRight, 1: Actions.MoveLeft}
        for _ in range(10):
            env.step(actions)

        state = env.get_state()

        env2 = registry.make("SearchRescue-Test-V0")
        env2.set_state(state)

        assert env.t == env2.t == 10
        np.testing.assert_array_equal(
            env.grid.encode(scope=env.scope),
            env2.grid.encode(scope=env2.scope)
        )
```
  </action>
  <verify>
Run: `pytest -v cogrid/envs/search_rescue/test_sr_env_serialization.py`
All 5 tests should pass.
  </verify>
  <done>
New test file exists with 5 passing tests covering S&R environment-level serialization roundtrip.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add termination state preservation test</name>
  <files>cogrid/envs/search_rescue/test_sr_env_serialization.py</files>
  <action>
Add test `test_termination_preserved_after_restore` to verify that:
1. When all victims are rescued (environment terminates), the termination state is preserved after roundtrip
2. Specifically:
   - Reset environment
   - Remove all victims from grid (simulating they were rescued)
   - Take a step to trigger termination check
   - Save state
   - Restore to new env
   - Verify all agents have terminated=True

This tests the S&R-specific termination logic in SearchRescueEnv.get_terminateds_truncateds().

Also add `test_rng_state_preservation_sr` to verify RNG state is preserved (parallel to Overcooked test).
  </action>
  <verify>
Run: `pytest -v cogrid/envs/search_rescue/test_sr_env_serialization.py::TestSearchRescueEnvSerialization::test_termination_preserved_after_restore`
Run: `pytest -v cogrid/envs/search_rescue/test_sr_env_serialization.py::TestSearchRescueEnvSerialization::test_rng_state_preservation_sr`
Both tests should pass.
  </verify>
  <done>
Test file now has 7 tests covering environment roundtrip, termination preservation, and RNG state preservation.
  </done>
</task>

</tasks>

<verification>
Run all S&R serialization tests together:
```bash
pytest -v cogrid/envs/search_rescue/test_sr_env_serialization.py \
       cogrid/envs/search_rescue/test_sr_objects_serialization.py \
       cogrid/envs/search_rescue/test_redvictim_serialization.py
```
All tests should pass. New file should have ~7 tests.
</verification>

<success_criteria>
- [ ] New file `cogrid/envs/search_rescue/test_sr_env_serialization.py` exists
- [ ] Contains TestSearchRescueEnvSerialization class with ~7 tests
- [ ] Tests cover: basic get_state, roundtrip after reset, roundtrip after steps, RedVictim mid-rescue, agent inventory, termination preservation, RNG preservation
- [ ] All tests pass
- [ ] Test patterns match existing Overcooked integration tests
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing/06-01-SUMMARY.md`
</output>
