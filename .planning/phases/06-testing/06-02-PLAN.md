---
phase: 06-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/tests/test_serialization_integration.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Extended action sequences (50+ steps) produce identical results after checkpoint/restore"
    - "Observation spaces match exactly between original and restored environments"
    - "Cross-environment validation confirms serialization works for both Overcooked and S&R"
    - "All tests pass in single pytest run"
  artifacts:
    - path: "cogrid/tests/test_serialization_integration.py"
      provides: "Centralized integration tests for state serialization"
      min_lines: 100
      contains: "class TestDeterminismExtended"
  key_links:
    - from: "test_serialization_integration.py"
      to: "Overcooked-CrampedRoom-V0"
      via: "registry.make"
      pattern: "registry\\.make.*Overcooked"
    - from: "test_serialization_integration.py"
      to: "SearchRescue-Test-V0"
      via: "registry.make"
      pattern: "registry\\.make.*SearchRescue"
---

<objective>
Create centralized integration test file with extended determinism tests and cross-environment validation.

Purpose: Enhance TEST-03 coverage with longer action sequences and create single entry point for serialization integration tests
Output: New test file `cogrid/tests/test_serialization_integration.py` with ~5 tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-testing/06-RESEARCH.md

# Existing determinism test pattern
@cogrid/envs/overcooked/test_state_serialization.py (lines 147-195 - test_deterministic_after_restore)

# Registered environments
@cogrid/envs/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests directory and integration test file</name>
  <files>cogrid/tests/__init__.py, cogrid/tests/test_serialization_integration.py</files>
  <action>
Create `cogrid/tests/` directory if it doesn't exist. Create empty `__init__.py`.

Create `test_serialization_integration.py` with:

1. `TestDeterminismExtended` class with:
   - `test_overcooked_extended_determinism` - Run 50 steps, save, continue 50 more steps, restore, run same 50 steps, verify rewards and observations match exactly at each step
   - `test_search_rescue_extended_determinism` - Same pattern for S&R environment

Pattern:
```python
import pytest
import numpy as np
import copy
from cogrid.core.actions import Actions
from cogrid.envs import registry

class TestDeterminismExtended:
    """Extended determinism tests with longer action sequences."""

    def test_overcooked_extended_determinism(self):
        """Test 50-step determinism for Overcooked environment."""
        env1 = registry.make("Overcooked-CrampedRoom-V0")
        env1.reset(seed=42)

        # Run 50 steps to reach interesting state
        actions_list = [{0: Actions.MoveRight, 1: Actions.MoveLeft}] * 25
        actions_list += [{0: Actions.MoveUp, 1: Actions.MoveDown}] * 25
        for actions in actions_list:
            env1.step(actions)

        # Save checkpoint
        state = env1.get_state()

        # Continue 50 more steps, recording results
        test_actions = [{0: Actions.MoveDown, 1: Actions.MoveUp}] * 50
        env1_results = []
        for actions in test_actions:
            obs, rewards, _, _, _ = env1.step(actions)
            env1_results.append({
                'rewards': copy.deepcopy(rewards),
                'obs_shapes': {k: v.shape for k, v in obs.items()}
            })

        # Restore and run same sequence
        env2 = registry.make("Overcooked-CrampedRoom-V0")
        env2.set_state(state)

        for i, actions in enumerate(test_actions):
            obs, rewards, _, _, _ = env2.step(actions)
            # Verify rewards match
            for agent_id in rewards:
                assert rewards[agent_id] == env1_results[i]['rewards'][agent_id], \
                    f"Reward mismatch at step {i} for agent {agent_id}"
```

2. `TestObservationSpaceMatch` class with:
   - `test_observation_arrays_match_after_restore` - Verify actual observation array values match, not just shapes

This ensures numerical precision is maintained through serialization.
  </action>
  <verify>
Run: `pytest -v cogrid/tests/test_serialization_integration.py`
All tests should pass.
  </verify>
  <done>
New directory and test file exist with TestDeterminismExtended class containing 2 extended tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add cross-environment and edge case tests</name>
  <files>cogrid/tests/test_serialization_integration.py</files>
  <action>
Add to the integration test file:

1. `TestCrossEnvironmentValidation` class with:
   - `test_all_registered_envs_support_serialization` - Iterate through ["Overcooked-CrampedRoom-V0", "SearchRescue-Test-V0"], verify each supports get_state/set_state roundtrip
   - Use parametrize decorator for clean test per environment

2. `TestEdgeCaseSerialization` class with:
   - `test_max_steps_boundary` - Create env with max_steps=10, step to t=9, save, restore, verify next step triggers truncation
   - `test_empty_grid_positions` - Verify empty grid cells (Floor objects) are correctly preserved

Pattern for parametrized test:
```python
@pytest.mark.parametrize("env_name", [
    "Overcooked-CrampedRoom-V0",
    "SearchRescue-Test-V0",
])
def test_environment_supports_serialization(self, env_name):
    """Verify environment supports get_state/set_state roundtrip."""
    env = registry.make(env_name)
    env.reset(seed=42)

    # Take some steps
    actions = {i: Actions.Noop for i in env.agent_ids}
    for _ in range(5):
        env.step(actions)

    # Roundtrip
    state = env.get_state()
    env2 = registry.make(env_name)
    env2.set_state(state)

    # Verify timestep matches
    assert env.t == env2.t
```
  </action>
  <verify>
Run: `pytest -v cogrid/tests/test_serialization_integration.py`
All tests should pass (~5-6 total tests).
  </verify>
  <done>
Integration test file complete with extended determinism, observation matching, cross-environment validation, and edge case tests.
  </done>
</task>

</tasks>

<verification>
Run complete serialization test suite:
```bash
pytest -v cogrid/tests/test_serialization_integration.py \
       cogrid/envs/overcooked/test_state_serialization.py \
       cogrid/envs/search_rescue/test_sr_objects_serialization.py \
       cogrid/envs/search_rescue/test_redvictim_serialization.py
```

Total tests should be ~70+ (62 existing + ~5-6 new integration + ~7 new S&R env tests).
All tests should pass.
</verification>

<success_criteria>
- [ ] Directory `cogrid/tests/` exists with `__init__.py`
- [ ] File `cogrid/tests/test_serialization_integration.py` exists
- [ ] Contains TestDeterminismExtended with 2 extended tests (50+ step sequences)
- [ ] Contains TestCrossEnvironmentValidation with parametrized env tests
- [ ] Contains TestEdgeCaseSerialization with boundary condition tests
- [ ] All tests pass
- [ ] Total serialization test count is ~70+
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing/06-02-SUMMARY.md`
</output>
