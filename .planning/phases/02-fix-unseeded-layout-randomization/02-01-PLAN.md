# Plan 02-01: Thread np_random to Layout Functions

## Frontmatter

```yaml
wave: 1
depends_on: []
files_modified:
  - cogrid/cogrid_env.py
  - cogrid/envs/__init__.py
  - cogrid/tests/test_determinism.py
autonomous: true
```

## Objective

Fix unseeded layout randomization by threading `np_random` through to `layout_fn`. The `Overcooked-RandomizedLayout-V0` environment currently uses Python's `random.choice()` which is not connected to the environment seed, breaking determinism.

## Context

**Problem:** [envs/__init__.py:128](../../cogrid/envs/__init__.py#L128) uses `random.choice()` to select layouts:
```python
def randomized_layout_fn(**kwargs):
    layout_name = random.choice([...])  # BUG: unseeded
```

**Fix:**
1. Pass `np_random` when calling `layout_fn` in `cogrid_env.py`
2. Update `randomized_layout_fn` to use the passed RNG

## Tasks

<task id="1">
Edit cogrid/cogrid_env.py to pass np_random to layout_fn.

In `_generate_encoded_grid_states()` around line 219, change:
```python
layout_name, layout, state_encoding = layout_fn(**grid_config)
```

To:
```python
layout_name, layout, state_encoding = layout_fn(np_random=self.np_random, **grid_config)
```
</task>

<task id="2">
Edit cogrid/envs/__init__.py to use the passed np_random.

Change `randomized_layout_fn` to:
```python
def randomized_layout_fn(np_random=None, **kwargs):
    if np_random is None:
        import random as stdlib_random
        layout_name = stdlib_random.choice([...])  # Fallback for backwards compat
    else:
        layout_name = np_random.choice([...])
    return layout_name, *layouts.get_layout(layout_name)
```

Also remove `import random` from the top of the file since it's no longer needed at module level.
</task>

<task id="3">
Add determinism test for RandomizedLayout to cogrid/tests/test_determinism.py.

Add a new test class or method:
```python
def test_randomized_layout_deterministic(self):
    """Same seed produces same layout selection."""
    layouts_run1 = []
    layouts_run2 = []

    for _ in range(5):
        env = registry.make("Overcooked-RandomizedLayout-V0")
        env.reset(seed=42)
        layouts_run1.append(env.current_layout_id)
        env.close()

    for _ in range(5):
        env = registry.make("Overcooked-RandomizedLayout-V0")
        env.reset(seed=42)
        layouts_run2.append(env.current_layout_id)
        env.close()

    self.assertEqual(layouts_run1, layouts_run2, "RandomizedLayout not deterministic")
```
</task>

<task id="4">
Run all determinism tests to verify:

```bash
pytest cogrid/tests/test_determinism.py -v
```
</task>

## Verification

```bash
# All determinism tests pass including new RandomizedLayout test
pytest cogrid/tests/test_determinism.py -v

# Existing tests still pass
pytest cogrid/envs/overcooked/test_state_serialization.py -v
```

## must_haves

- [ ] `random.choice` no longer used for layout selection in normal flow
- [ ] `np_random` passed to `layout_fn` from cogrid_env.py
- [ ] `randomized_layout_fn` uses passed `np_random`
- [ ] Same seed produces same layout selection
- [ ] Existing tests still pass
