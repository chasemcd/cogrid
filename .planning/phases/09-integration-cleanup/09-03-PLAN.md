---
phase: 09-integration-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - cogrid/core/jax_step.py
  - cogrid/feature_space/array_features.py
  - cogrid/envs/overcooked/array_rewards.py
  - cogrid/tests/test_step_pipeline.py
  - cogrid/tests/test_cross_backend_parity.py
  - cogrid/tests/test_vmap_correctness.py
autonomous: true

must_haves:
  truths:
    - "cogrid/core/jax_step.py does not exist"
    - "No _jax suffixed backward-compat aliases exist anywhere in the codebase"
    - "All test files pass without ImportError"
    - "vmap at 1024 environments works with the unified step function"
  artifacts:
    - path: "cogrid/feature_space/array_features.py"
      provides: "Feature functions without _jax aliases"
    - path: "cogrid/envs/overcooked/array_rewards.py"
      provides: "Reward functions without _jax alias"
    - path: "cogrid/tests/test_cross_backend_parity.py"
      provides: "Updated tests using unified function names"
  key_links:
    - from: "cogrid/tests/test_cross_backend_parity.py"
      to: "cogrid/core/step_pipeline.py"
      via: "direct import of step, reset, envstate_to_dict"
      pattern: "from cogrid.core.step_pipeline import"
---

<objective>
Delete all dead code (jax_step.py shim, backward-compat aliases), update all imports, fix all tests to use unified function names, and verify vmap at 1024 environments.

Purpose: Satisfies CLEAN-01 (delete _jax aliases), CLEAN-03 (delete jax_step.py), TEST-03 (vmap at 1024), and TEST-04 (test verification). This is the final cleanup pass that removes all transitional code from Phases 5-8.

Output: A clean codebase with zero backward-compat shims, all tests passing, and vmap verified at scale.
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-cleanup/09-01-SUMMARY.md
@cogrid/core/jax_step.py
@cogrid/feature_space/array_features.py
@cogrid/envs/overcooked/array_rewards.py
@cogrid/tests/test_step_pipeline.py
@cogrid/tests/test_cross_backend_parity.py
@cogrid/tests/test_vmap_correctness.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete jax_step.py and backward-compat aliases</name>
  <files>cogrid/core/jax_step.py, cogrid/feature_space/array_features.py, cogrid/envs/overcooked/array_rewards.py</files>
  <action>
**A. Delete cogrid/core/jax_step.py entirely.** It is a 7-line backward-compat shim that re-exports from step_pipeline.py. All callers have been updated (or will be updated in this task) to import directly from step_pipeline.

**B. Delete backward-compat aliases in cogrid/feature_space/array_features.py:**
- Line 292: `build_feature_fn_jax = build_feature_fn` -- DELETE this line
- Line 293: `get_all_agent_obs_jax = get_all_agent_obs` -- DELETE this line

**C. Delete backward-compat alias in cogrid/envs/overcooked/array_rewards.py:**
- Line 315: `compute_rewards_jax = compute_rewards` -- DELETE this line

After deletion, verify no code in the codebase still imports these names:
- `grep -r "jax_step" cogrid/ --include="*.py"` should return nothing except possibly test files (fixed in Task 2)
- `grep -r "build_feature_fn_jax\|get_all_agent_obs_jax\|compute_rewards_jax" cogrid/ --include="*.py"` should return nothing except test files
  </action>
  <verify>
`ls cogrid/core/jax_step.py` returns file not found.
`grep -c "build_feature_fn_jax" cogrid/feature_space/array_features.py` returns 0.
`grep -c "get_all_agent_obs_jax" cogrid/feature_space/array_features.py` returns 0.
`grep -c "compute_rewards_jax" cogrid/envs/overcooked/array_rewards.py` returns 0.
  </verify>
  <done>jax_step.py is deleted and all _jax backward-compat aliases are removed from the codebase.</done>
</task>

<task type="auto">
  <name>Task 2: Update tests to use unified imports and verify vmap</name>
  <files>cogrid/tests/test_step_pipeline.py, cogrid/tests/test_cross_backend_parity.py, cogrid/tests/test_vmap_correctness.py</files>
  <action>
**A. test_step_pipeline.py:**
- Delete `test_backward_compat_aliases()` function entirely (lines 347-361). This test verified the jax_step.py shim which no longer exists.

**B. test_cross_backend_parity.py -- update imports and delete stale tests:**

1. Delete `test_move_agents_jax_eager_vs_jit()` (lines 478-520). This test imports `move_agents_jax` which was a Phase 1 function that no longer exists. The unified `move_agents` is already tested elsewhere.

2. Delete `test_process_interactions_jax_eager_vs_jit()` (lines 523-572). This test imports `process_interactions_jax` which no longer exists. The unified `process_interactions` is already tested.

3. Update `test_obs_jax_eager_vs_jit()` (lines 575-616):
   - Change `from cogrid.feature_space.array_features import get_all_agent_obs_jax` to `from cogrid.feature_space.array_features import get_all_agent_obs`
   - Change `from cogrid.core.jax_step import envstate_to_dict` to `from cogrid.core.step_pipeline import envstate_to_dict`
   - Replace all occurrences of `get_all_agent_obs_jax` with `get_all_agent_obs` in this function
   - Update docstring and error messages to remove `_jax` suffix

4. Update `test_rewards_jax_eager_vs_jit()` (lines 619+):
   - Change `from cogrid.core.jax_step import envstate_to_dict` to `from cogrid.core.step_pipeline import envstate_to_dict`

5. Update any other `from cogrid.core.jax_step import ...` imports in the file:
   - Line 320: `from cogrid.core.jax_step import jax_step, jax_reset` -> `from cogrid.core.step_pipeline import step, reset` and update the function body to use the new names
   - Audit the entire file for any remaining references to deleted names

**C. test_vmap_correctness.py:**
- Read the file and verify it uses `env.jax_step` / `env.jax_reset` (which are still exposed on the wrapper).
- If it imports from `jax_step.py`, update to import from `step_pipeline.py`.
- Ensure the vmap test runs at 1024 environments. If the current test uses a smaller batch size, update it to 1024 (per TEST-03 requirement).

**D. Run the full test suite:**
`python -m pytest cogrid/tests/ -x -q` -- ALL tests must pass.
  </action>
  <verify>
`python -m pytest cogrid/tests/test_step_pipeline.py -x -q` passes.
`python -m pytest cogrid/tests/test_cross_backend_parity.py -x -q` passes.
`python -m pytest cogrid/tests/test_vmap_correctness.py -x -q` passes.
`grep -r "from cogrid.core.jax_step" cogrid/ --include="*.py"` returns nothing.
`grep -r "move_agents_jax\|process_interactions_jax\|build_feature_fn_jax\|get_all_agent_obs_jax\|compute_rewards_jax" cogrid/ --include="*.py"` returns nothing.
  </verify>
  <done>All tests pass with unified imports. No references to deleted functions remain. vmap at 1024 environments verified. Zero backward-compat code remains in the codebase.</done>
</task>

</tasks>

<verification>
1. `ls cogrid/core/jax_step.py` returns file not found
2. `grep -r "jax_step\|_jax" cogrid/ --include="*.py" | grep -v "__pycache__" | grep -v "jax_step_wrapper\|jax_step.*property\|jax_reset.*property"` returns nothing (no stale references)
3. `python -m pytest cogrid/tests/ -x -q` -- ALL tests pass
4. vmap at 1024 environments test passes
5. `grep -r "from cogrid.core.jax_step" cogrid/ --include="*.py"` returns nothing
</verification>

<success_criteria>
- jax_step.py is deleted
- All _jax backward-compat aliases are deleted
- All test imports updated to unified function names
- Stale tests deleted (test_backward_compat_aliases, test_move_agents_jax_eager_vs_jit, test_process_interactions_jax_eager_vs_jit)
- Full test suite passes
- vmap at 1024 environments verified
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-cleanup/09-03-SUMMARY.md`
</output>
