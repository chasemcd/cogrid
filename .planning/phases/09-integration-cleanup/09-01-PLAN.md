---
phase: 09-integration-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/core/step_pipeline.py
  - cogrid/envs/overcooked/array_config.py
autonomous: true

must_haves:
  truths:
    - "step_pipeline.py contains zero imports from cogrid.envs.*"
    - "step_pipeline.py contains zero hardcoded 'overcooked.' string literals"
    - "step() and reset() work identically before and after the refactor on both backends"
  artifacts:
    - path: "cogrid/core/step_pipeline.py"
      provides: "Scope-generic step/reset pipeline"
      contains: "tick_handler(state, scope_config)"
    - path: "cogrid/envs/overcooked/array_config.py"
      provides: "Updated tick handler signature accepting (state, scope_config)"
  key_links:
    - from: "cogrid/core/step_pipeline.py"
      to: "scope_config"
      via: "scope_config callbacks (tick_handler, reward compute_fn)"
      pattern: "scope_config"
---

<objective>
Remove all Overcooked-specific hardcoding from `step_pipeline.py` so that `cogrid/core/` contains zero environment-specific logic.

Purpose: Satisfies CLEAN-04. The step pipeline must be scope-generic -- environment-specific behavior (tick, interaction details, rewards) flows through scope_config callbacks and extra_state dicts, not hardcoded imports or key names.

Output: A step_pipeline.py that has zero imports from `cogrid.envs.*`, zero hardcoded `"overcooked.*"` string literals, and passes all existing tests.
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@cogrid/core/step_pipeline.py
@cogrid/envs/overcooked/array_config.py
@cogrid/envs/overcooked/array_rewards.py
@cogrid/core/interactions.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make step_pipeline.py scope-generic</name>
  <files>cogrid/core/step_pipeline.py, cogrid/envs/overcooked/array_config.py</files>
  <action>
Refactor step_pipeline.py to remove ALL Overcooked-specific hardcoding. There are 4 areas to fix:

**A. Reward import (line 133)**: Remove `from cogrid.envs.overcooked.array_rewards import compute_rewards`. Instead, the reward function should come from `reward_config["compute_fn"]`. Update `step()` to call `reward_config["compute_fn"](prev_dict, state_dict, actions, reward_config)` instead of `compute_rewards(...)`. Update `build_step_fn()` docstring accordingly. The caller (cogrid_env.py) already builds reward_config -- it must also add a `"compute_fn"` key pointing to the actual compute_rewards function. For now, just change step_pipeline.py to expect it.

**B. Tick section (lines 140-162)**: Replace the hardcoded `state.extra_state["overcooked.pot_contents"]` access pattern. Change the tick handler signature from `(pot_contents, pot_timer) -> (pot_contents, pot_timer, pot_state)` to `(state, scope_config) -> state`. The tick handler receives the full EnvState and returns a new EnvState with updated extra_state and object_state_map. This means:
- In step_pipeline.py: replace the entire tick block (lines 140-162) with:
  ```python
  tick_handler = scope_config.get("tick_handler") if scope_config else None
  if tick_handler is not None:
      state = tick_handler(state, scope_config)
  ```
- In cogrid/envs/overcooked/array_config.py: create a new wrapper function `overcooked_tick_state(state, scope_config)` that extracts pot_contents/pot_timer from state.extra_state, calls the existing `overcooked_tick()`, writes pot_state into object_state_map using set_at_2d, and returns the updated state via dataclasses.replace. Update the scope config dict (line 88) to point `"tick_handler"` at this new wrapper. Keep the original `overcooked_tick()` as an internal helper.

**C. Interaction section (lines 206-214)**: Replace hardcoded `pot_contents=state.extra_state["overcooked.pot_contents"]` kwargs. Instead, pass the unprefixed extra_state generically:
```python
# Build unprefixed extra_state dict for process_interactions
extra_kwargs = {}
for key, val in state.extra_state.items():
    short_key = key.split(".", 1)[-1] if "." in key else key
    extra_kwargs[short_key] = val

agent_inv, otm, osm, extra_out = process_interactions(
    ...,
    **extra_kwargs,
)
```
Then re-prefix the returned extra_out keys back into extra_state:
```python
scope_prefix = next((k.split(".")[0] for k in state.extra_state if "." in k), None)
new_extra = dict(state.extra_state)
for k, v in extra_out.items():
    prefixed = f"{scope_prefix}.{k}" if scope_prefix else k
    if prefixed in new_extra:
        new_extra[prefixed] = v
```

**D. Reset section (lines 325-329)**: Replace hardcoded `"overcooked.pot_*"` keys. Instead, build extra_state from layout_arrays generically using a scope_config callback or a convention. The simplest approach: add an `extra_state_builder` to scope_config (or use a default convention). For now, use the convention that any key in layout_arrays NOT in {"wall_map", "object_type_map", "object_state_map"} is an extra_state entry, prefixed with `{scope}.`:
```python
base_keys = {"wall_map", "object_type_map", "object_state_map"}
scope = scope_config.get("scope", "global") if scope_config else "global"
extra_state = {}
for key, val in layout_arrays.items():
    if key not in base_keys:
        extra_state[f"{scope}.{key}"] = val
```
Also remove the `pot_capacity` and `cooking_time` parameters from `reset()` since they are Overcooked-specific -- these should be configured in the scope config or tick handler closure, not as reset parameters.

After all changes, verify: `grep -r "overcooked" cogrid/core/step_pipeline.py` returns nothing. `grep -r "from cogrid.envs" cogrid/core/step_pipeline.py` returns nothing.
  </action>
  <verify>
Run: `python -c "from cogrid.core.step_pipeline import step, reset, build_step_fn, build_reset_fn"` succeeds.
Run: `grep -c "overcooked" cogrid/core/step_pipeline.py` returns 0.
Run: `grep -c "from cogrid.envs" cogrid/core/step_pipeline.py` returns 0.
Run: `python -m pytest cogrid/tests/test_step_pipeline.py -x -q` -- all tests pass.
  </verify>
  <done>step_pipeline.py has zero Overcooked-specific imports, zero hardcoded "overcooked." string literals, and all existing step pipeline tests pass unchanged.</done>
</task>

</tasks>

<verification>
1. `grep -r "overcooked" cogrid/core/step_pipeline.py` returns empty (no matches)
2. `grep -r "from cogrid.envs" cogrid/core/step_pipeline.py` returns empty (no matches)
3. `python -m pytest cogrid/tests/test_step_pipeline.py -x -q` passes
4. The overcooked tick handler still works correctly (verified by step pipeline tests that use the Overcooked scope)
</verification>

<success_criteria>
- step_pipeline.py is fully scope-generic with zero environment-specific references
- All callbacks (tick_handler, reward compute_fn) come from scope_config or reward_config
- Extra_state keys are handled generically via prefix convention
- All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-cleanup/09-01-SUMMARY.md`
</output>
