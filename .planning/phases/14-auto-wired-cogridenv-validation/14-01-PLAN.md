---
phase: 14-auto-wired-cogridenv-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/cogrid_env.py
  - cogrid/envs/overcooked/__init__.py
autonomous: true

must_haves:
  truths:
    - "CoGridEnv.__init__() calls build_scope_config_from_components() instead of get_scope_config()"
    - "CoGridEnv.__init__() calls build_reward_config_from_components() instead of manual reward_config assembly"
    - "No `if self.scope == 'overcooked'` branch exists in cogrid_env.py"
    - "CoGridEnv.reset() calls extra_state_builder after layout_to_array_state to populate pot state"
    - "overcooked/__init__.py no longer calls register_scope_config or register_symbols"
    - "All 85+ existing tests pass without modification"
  artifacts:
    - path: "cogrid/cogrid_env.py"
      provides: "Auto-wired scope_config and reward_config via autowire module"
      contains: "build_scope_config_from_components"
    - path: "cogrid/envs/overcooked/__init__.py"
      provides: "Import-time component registration only (no manual scope_config/symbol registration)"
  key_links:
    - from: "cogrid/cogrid_env.py"
      to: "cogrid/core/autowire.py"
      via: "build_scope_config_from_components and build_reward_config_from_components calls"
      pattern: "build_scope_config_from_components|build_reward_config_from_components"
    - from: "cogrid/cogrid_env.py reset()"
      to: "scope_config extra_state_builder"
      via: "extra_state_builder(self._array_state, self.scope) call after layout_to_array_state"
      pattern: "extra_state_builder.*self._array_state"
---

<objective>
Replace manual scope_config and reward_config wiring in CoGridEnv.__init__() with auto-wiring from component registries, and handle the extra_state_builder gap in reset().

Purpose: This is the "flip the switch" change -- CoGridEnv goes from manual get_scope_config() + `if scope == "overcooked"` branches to generic auto-wiring that works for any scope with registered components. After this plan, the environment initialization path is scope-agnostic.

Output: Modified cogrid_env.py and overcooked/__init__.py with all 85+ existing tests passing.
</objective>

<execution_context>
@/Users/chasemcd/.claude/get-shit-done/workflows/execute-plan.md
@/Users/chasemcd/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-auto-wired-cogridenv-validation/14-RESEARCH.md
@.planning/phases/13-overcooked-migration/13-03-SUMMARY.md
@cogrid/cogrid_env.py
@cogrid/core/autowire.py
@cogrid/envs/overcooked/__init__.py
@cogrid/core/grid_utils.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire CoGridEnv.__init__() to use auto-wiring for scope_config and reward_config</name>
  <files>cogrid/cogrid_env.py, cogrid/envs/overcooked/__init__.py</files>
  <action>
  In `cogrid/cogrid_env.py`, make these changes to `__init__()`:

  **Scope config (replace lines ~207-211):**
  Replace the `from cogrid.core.scope_config import get_scope_config` / `self._scope_config = get_scope_config(self.scope)` block with:
  ```python
  from cogrid.core.autowire import (
      build_scope_config_from_components,
      build_reward_config_from_components,
  )
  self._scope_config = build_scope_config_from_components(self.scope)
  self._type_ids = self._scope_config["type_ids"]
  self._interaction_tables = self._scope_config.get("interaction_tables")
  ```
  Keep `self._type_ids` and `self._interaction_tables` assignments on their existing lines (they are read downstream).

  **Reward config (replace lines ~237-257):**
  Replace the entire `jax_reward_specs` loop, manual `self._reward_config` dict, and the `if self.scope == "overcooked"` branch with:
  ```python
  self._reward_config = build_reward_config_from_components(
      self.scope,
      n_agents=self.config["num_agents"],
      type_ids=self._type_ids,
      action_pickup_drop_idx=self._action_pickup_drop_idx,
  )
  ```
  This MUST come AFTER the `self._action_pickup_drop_idx` computation (lines ~230-232). Preserve that ordering.

  **Audit entire cogrid_env.py for ALL scope-specific branches:**
  After making the above changes, search the ENTIRE file for any remaining `if self.scope ==` or `if scope ==` conditionals. There is at least one at line ~255 (`if self.scope == "overcooked"`). ALL such branches must be removed or replaced with generic auto-wiring equivalents. Grep with `grep -n "if.*scope.*==" cogrid/cogrid_env.py` and address every match.

  **In `cogrid/envs/overcooked/__init__.py`:**
  Replace the entire file contents. Remove the `register_scope_config` and `register_symbols` calls. Keep the `overcooked_features` import and add explicit imports to trigger component registration:
  ```python
  from cogrid.envs.overcooked import overcooked_features
  from cogrid.envs.overcooked import overcooked_grid_objects  # noqa: F401 -- triggers @register_object_type
  from cogrid.envs.overcooked import array_rewards  # noqa: F401 -- triggers @register_reward_type
  ```
  The `overcooked_grid_objects` import ensures Pot and other GridObject subclasses are registered. The `array_rewards` import ensures ArrayReward subclasses (DeliveryReward, etc.) are registered. Without these imports, `build_scope_config_from_components("overcooked")` would find zero components.

  **CRITICAL ordering note:** The `overcooked_grid_objects` import may already be triggered indirectly through the existing import chain. Verify by checking `cogrid/envs/overcooked/overcooked_grid_objects.py` is imported somewhere. If it is already imported via the `overcooked_features` import chain, the explicit import is harmless but safe.
  </action>
  <verify>
  Run `python -m pytest cogrid/tests/ cogrid/envs/ -x -q` -- all tests must pass. Specifically confirm:
  - `test_cross_backend_parity.py` passes (creates envs via registry, now uses auto-wiring path)
  - `test_vmap_correctness.py` passes (1024-env vmap, now through auto-wiring)
  - `test_overcooked_migration.py` passes (parity tests still comparing auto-wired vs manual)
  </verify>
  <done>CoGridEnv.__init__() uses build_scope_config_from_components() and build_reward_config_from_components() with zero scope-specific branches. overcooked/__init__.py triggers registration via imports only. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Handle extra_state_builder gap in CoGridEnv.reset()</name>
  <files>cogrid/cogrid_env.py</files>
  <action>
  The auto-wired scope_config has `state_extractor=None`, so `layout_to_array_state()` will NOT extract pot arrays (pot_contents, pot_timer, pot_positions). The extra_state_builder in the auto-wired config works on parsed arrays (dict with object_type_map), not Grid objects.

  In `cogrid/cogrid_env.py reset()`, after the `layout_to_array_state()` call (currently line ~440) and BEFORE `agent_arrays` is merged, add extra_state_builder handling:

  ```python
  self._array_state = layout_to_array_state(
      self.grid, scope=self.scope, scope_config=self._scope_config
  )

  # Build extra state from autowired builder (e.g. pot arrays for Overcooked)
  extra_state_builder = self._scope_config.get("extra_state_builder")
  if extra_state_builder is not None:
      extra = extra_state_builder(self._array_state, self.scope)
      self._array_state.update(extra)

  agent_arrays = create_agent_arrays(self.env_agents, scope=self.scope)
  self._array_state.update(agent_arrays)
  ```

  The extra_state_builder receives `self._array_state` (which at this point has object_type_map, object_state_map, wall_map, spawn_points) and the scope string. For Overcooked, Pot.extra_state_builder() returns pot_contents, pot_timer, pot_positions computed from the object_type_map. The result is merged into _array_state before agent arrays are added.

  **Verify this works:** The Overcooked Pot.build_extra_state_builder() classmethod (added in Phase 13-01) produces a function that takes (parsed_arrays, scope) and returns a dict with pot_contents, pot_timer, pot_positions. Check that the function signature matches: `extra_state_builder(parsed_arrays_dict, scope_str) -> dict`.
  </action>
  <verify>
  Run `python -m pytest cogrid/tests/test_cross_backend_parity.py -x -q` (exercises full Overcooked step pipeline including pot interactions). Run `python -m pytest cogrid/tests/test_step_pipeline.py -x -q` (step pipeline tests). Both must pass, confirming pot state is correctly populated in reset.
  </verify>
  <done>CoGridEnv.reset() builds extra state via the autowired extra_state_builder after layout_to_array_state(). Overcooked pot arrays are correctly populated. All step pipeline and cross-backend parity tests pass.</done>
</task>

</tasks>

<verification>
1. `grep -n "get_scope_config" cogrid/cogrid_env.py` returns zero matches
2. `grep -n "if self.scope ==" cogrid/cogrid_env.py` returns zero matches
3. `grep -n "register_scope_config\|register_symbols" cogrid/envs/overcooked/__init__.py` returns zero matches
4. `grep -n "build_scope_config_from_components\|build_reward_config_from_components" cogrid/cogrid_env.py` returns 2+ matches
5. `python -m pytest cogrid/tests/ cogrid/envs/ -x -q` -- all tests pass
</verification>

<success_criteria>
CoGridEnv.__init__() and reset() use auto-wiring exclusively. No scope-specific branches remain. All 85+ existing tests pass without modification. The overcooked/__init__.py triggers registration via decorator imports only.
</success_criteria>

<output>
After completion, create `.planning/phases/14-auto-wired-cogridenv-validation/14-01-SUMMARY.md`
</output>
