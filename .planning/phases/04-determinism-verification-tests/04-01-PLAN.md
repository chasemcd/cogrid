---
phase: 04-determinism-verification-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cogrid/tests/test_determinism.py
autonomous: true

must_haves:
  truths:
    - "Same seed + same actions produces identical state after 100 steps"
    - "Restored state continues identically to original environment"
    - "Agent collision resolution is deterministic across 10 runs"
    - "RandomizedLayout produces same layout for same seed"
  artifacts:
    - path: "cogrid/tests/test_determinism.py"
      provides: "Determinism verification test suite"
      contains: "100"
  key_links:
    - from: "cogrid/tests/test_determinism.py"
      to: "cogrid/envs/registry"
      via: "registry.make() for env creation"
      pattern: "registry\\.make"
---

<objective>
Complete the determinism verification test suite by updating existing tests to match scope requirements.

Purpose: Ensure all determinism guarantees are tested at the levels specified in the roadmap (100 steps, restored state continuation).
Output: Updated test_determinism.py with comprehensive determinism tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/ROADMAP.md
@.planning/STATE.md

@cogrid/tests/test_determinism.py
@cogrid/tests/test_serialization_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend trajectory test to 100 steps and add restored state test</name>
  <files>cogrid/tests/test_determinism.py</files>
  <action>
Update the existing test_determinism.py file:

1. In test_identical_actions_produce_identical_states:
   - Change the loop from 50 steps to 100 steps (scope requirement)
   - The test structure can remain the same, just update the range

2. Add a new test class TestRestoredStateDeterminism with test_restored_state_identical_continuation:
   - Create env1, reset with seed=42
   - Run 50 steps to reach interesting state
   - Call get_state() to save checkpoint
   - Continue for 50 more steps, recording observations, rewards, terminated, truncated
   - Create env2, call set_state() with saved state
   - Run same 50 actions and verify all outputs match env1's recorded outputs
   - This explicitly tests "Restored state → identical continuation" from scope

Pattern to follow for restored state test (from test_serialization_integration.py):
- Use copy.deepcopy for rewards/terminated/truncated
- Use {k: v.copy() for k, v in obs.items()} for observations
- Compare step-by-step with assertEqual assertions

Import copy at top of file if not already present.
  </action>
  <verify>
Run tests:
```bash
cd /Users/chasemcd/Repositories/cogrid && python -m pytest cogrid/tests/test_determinism.py -v
```
All tests pass, including:
- test_randomized_layout_deterministic
- test_identical_actions_produce_identical_states (now 100 steps)
- test_collision_resolution_deterministic
- test_restored_state_identical_continuation (new)
  </verify>
  <done>
test_determinism.py contains:
- 100-step trajectory test (up from 50)
- Restored state continuation test (new)
- Both collision and layout tests remain passing
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full test suite passes</name>
  <files>cogrid/tests/test_determinism.py</files>
  <action>
Run the complete determinism test suite to ensure no regressions:

1. Run all determinism tests with verbose output
2. Run the serialization integration tests to ensure no conflicts
3. Confirm all 4 scope items are now covered:
   - Same seed → identical 100-step trajectory (updated test)
   - Restored state → identical continuation (new test)
   - Agent collision resolution is deterministic (existing)
   - RandomizedLayout produces same layout for same seed (existing)
  </action>
  <verify>
```bash
cd /Users/chasemcd/Repositories/cogrid && python -m pytest cogrid/tests/test_determinism.py cogrid/tests/test_serialization_integration.py -v
```
All tests pass.
  </verify>
  <done>
All determinism-related tests pass. The test suite now covers all 4 scope items from Phase 4.
  </done>
</task>

</tasks>

<verification>
1. Run full determinism test suite: `python -m pytest cogrid/tests/test_determinism.py -v`
2. Verify test names match scope items
3. Confirm 100-step test runs (not 50)
4. Confirm restored state test exists and passes
</verification>

<success_criteria>
- test_identical_actions_produce_identical_states runs for 100 steps
- test_restored_state_identical_continuation exists and passes
- All 4 scope items have corresponding tests
- No test regressions in existing determinism tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-determinism-verification-tests/04-01-SUMMARY.md`
</output>
